<!DOCTYPE html>
<html lang="en" style="--bg-page: #0d0d0d; --bg-ui: rgba(35, 38, 51, 0.4); --bg-ui-hover: rgba(55, 58, 71, 0.5); --text-color: #e2e8f0; --text-color-light: #94a3b8; --text-color-strong: #ffffff; --text-color-active-tab: #ffffff; --border-color: rgba(255, 255, 255, 0.1); --switch-bg-checked: #429eff; --contrast-color-light: #94a3b8;">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Moodinfinite v0.8.7</title>
    <link rel="icon" href="https://raw.githubusercontent.com/davidbrum25/moodinfinite/refs/heads/main/fav_icon_alternative.png" type="image/png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Source+Code+Pro:ital,wght@0,400;1,400&family=Roboto:ital,wght@0,400;0,700;1,400;1,700&family=Lato:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@400;700&family=Oswald:wght@400;700&family=Nunito:wght@400;700&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        :root {
            --tabs-bar-height: 48px;
        }
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-color: var(--bg-page);
            margin: 0;
            overscroll-behavior: none;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* --- CUSTOM SCROLLBAR STYLES --- */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        /* --- TABS SYSTEM STYLES (MODIFIED) --- */
        #tabs-bar {
            width: 100%;
            height: var(--tabs-bar-height);
            background: rgba(13, 13, 13, 0.8);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 8px;
            box-sizing: border-box;
            flex-shrink: 0;
            gap: 4px;
        }
        .tab-add-btn {
            background-color: transparent;
            border: 1px solid transparent;
            border-radius: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-color-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tab-add-btn:hover {
            background-color: var(--bg-ui-hover);
            color: var(--text-color);
        }
        .tabs-list-container {
            position: relative;
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            align-items: center;
        }
        .tabs-list {
            display: flex;
            height: 100%;
            align-items: flex-end;
            overflow-x: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .tabs-list::-webkit-scrollbar {
            display: none;
        }
        .scroll-indicator {
            position: absolute;
            top: 0;
            bottom: 8px;
            width: 40px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            z-index: 10;
        }
        .scroll-indicator.visible {
            opacity: 1;
        }
        .scroll-indicator.left {
            left: 0;
            background: linear-gradient(to right, rgba(13, 13, 13, 1), transparent);
        }
        .scroll-indicator.right {
            right: 0;
            background: linear-gradient(to left, rgba(13, 13, 13, 1), transparent);
        }

        .tab-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 12px;
            height: calc(var(--tabs-bar-height) - 9px);
            border: 1px solid transparent;
            border-bottom: none;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            cursor: pointer;
            color: var(--text-color-light);
            background-color: transparent;
            font-size: 0.875rem;
            white-space: nowrap;
        }
        .tab-item:hover {
            background-color: var(--bg-ui-hover);
            color: var(--text-color);
        }
        .tab-item.active {
            background-color: var(--bg-page);
            color: var(--text-color-active-tab);
            border-color: var(--border-color);
        }
        .tab-item.dragging {
            opacity: 0.4;
        }
        .tab-name {
            background: transparent;
            border: none;
            color: inherit;
            font-family: inherit;
            font-size: inherit;
            outline: none;
            padding: 2px 4px;
            border-radius: 4px;
            user-select: none;
            display: inline;
        }
        .tab-name-input {
            background: transparent;
            border: none;
            color: inherit;
            font-family: inherit;
            font-size: inherit;
            outline: none;
            padding: 2px 4px;
            border-radius: 4px;
            display: none;
        }
        .tab-name-input:focus {
            background-color: rgba(0,0,0,0.3);
            box-shadow: 0 0 0 1px var(--switch-bg-checked);
        }
        .tab-close-btn {
            background: transparent;
            border: none;
            color: var(--text-color-light);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
            font-size: 14px;
        }
        .tab-close-btn:hover {
            background-color: rgba(255,255,255,0.2);
            color: #fff;
        }
        
        #content-area {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }
        .tab-content {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        #moodprompt-container {
            background-color: var(--bg-page);
            color: var(--text-color);
            padding: 2rem 2rem 6rem 2rem;
            box-sizing: border-box;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .prompt-list {
            width: 100%;
            max-width: 1900px;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            gap: 1.5rem;
        }
        .prompt-card {
            background: var(--bg-ui);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: opacity 0.2s ease;
            width: 850px;
        }
        .prompt-card.dragging { opacity: 0.5; }
        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        .prompt-number {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-color-light);
            margin-right: 0.75rem;
            user-select: none;
        }
        .prompt-title-input {
            font-size: 1.25rem;
            font-weight: 700;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-color-strong);
            padding: 0.25rem 0;
            outline: none;
            width: 100%;
            transition: border-color 0.2s;
        }
        .prompt-title-input:focus { border-bottom-color: var(--switch-bg-checked); }
        .prompt-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-shrink: 0;
        }
        .prompt-delete-btn:hover { color: #ef4444; }
        .platform-select-wrapper { position: relative; }
        .platform-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: var(--bg-ui-hover);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--text-color);
            padding: 0.5rem 2.5rem 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .platform-select-wrapper::before {
            content: '';
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background-color: var(--text-color);
            mask-image: var(--icon-url);
            mask-size: contain;
            mask-repeat: no-repeat;
            mask-position: center;
            pointer-events: none;
        }
        .platform-select-wrapper::after {
            content: '▼';
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            color: var(--text-color-light);
            pointer-events: none;
        }

        .media-type-toggle {
            display: flex;
            background: var(--bg-ui-hover);
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .media-type-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-color-light);
            cursor: pointer;
        }
        .media-type-btn.active {
            background: var(--switch-bg-checked);
            color: white;
            font-weight: 600;
        }
        .prompt-body { display: flex; gap: 1rem; }
        .prompt-images { display: flex; gap: 1rem; flex-direction: column; }
        .image-upload-slot {
            width: 150px;
            height: 150px;
            border: 2px dashed var(--border-color);
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0,0,0,0.1);
            cursor: pointer;
            transition: border-color 0.2s;
            position: relative;
            overflow: hidden;
        }
        .image-upload-slot:hover { border-color: var(--switch-bg-checked); }
        .image-upload-slot .placeholder {
            color: var(--text-color-light);
            font-size: 0.8rem;
            text-align: center;
        }
        .image-upload-slot img { width: 100%; height: 100%; object-fit: cover; }
        .prompt-text-area {
            flex-grow: 1;
            background-color: rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem;
            color: var(--text-color);
            font-family: 'Source Code Pro', monospace;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 150px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .prompt-text-area:focus {
            border-color: var(--switch-bg-checked);
            box-shadow: 0 0 0 1px var(--switch-bg-checked);
        }
        #add-prompt-btn {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: auto;
            padding: 0.75rem 1.5rem;
            border: 2px dashed var(--contrast-color-light);
            border-radius: 1rem;
            background: var(--bg-ui);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: var(--contrast-color-light);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        #add-prompt-btn:hover {
            border-color: var(--switch-bg-checked);
            color: var(--switch-bg-checked);
            background: rgba(66, 158, 255, 0.1);
        }
        
        #moodinfinite-container { position: relative; width: 100%; height: 100%; }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
            background-color: var(--bg-canvas);
            cursor: grab;
        }
        canvas.grabbing { cursor: grabbing; }
        canvas.eyedropper-active { cursor: crosshair; }
        
        #left-bar {
            position: absolute;
            top: 50%;
            left: 1rem;
            transform: translateY(-50%);
            z-index: 50;
            background: var(--bg-ui);
            padding: 0.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }
        
        #context-menu, #confirmation-modal-overlay, #help-modal-overlay, #toast-container, #tab-context-menu { position: fixed; }
        #tab-context-menu {
            z-index: 2200;
            background: var(--bg-ui);
            border: 1px solid var(--border-color);
            border-radius: .75rem;
            box-shadow: 0 8px 32px 0 rgba(0,0,0,.37);
            padding: .5rem;
            display: none;
            width: 180px;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }
        
        #context-menu { z-index: 2100; }
        #confirmation-modal-overlay { z-index: 2000; }
        #help-modal-overlay { z-index: 3000; }
        #toast-container { z-index: 5000; }
        
        #context-menu{position:absolute;z-index:2100;background:var(--bg-ui);border:1px solid var(--border-color);border-radius:.75rem;box-shadow:0 8px 32px 0 rgba(0,0,0,.37);padding:.75rem;display:none;width:240px;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px)}.menu-item{display:flex;align-items:center;justify-content:space-between;padding:.4rem .5rem;border-radius:.375rem;cursor:pointer;transition:background-color .2s;color:var(--text-color)}.menu-item .text-red-500{color:#ef4444;text-shadow:0 1px 2px rgba(0,0,0,.4)}.menu-item:hover{background-color:var(--bg-ui-hover)}.menu-label{font-size:.875rem}.switch{position:relative;display:inline-block;width:38px;height:22px}.switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--border-color);transition:.4s;border-radius:22px}.slider:before{position:absolute;content:"";height:16px;width:16px;left:3px;bottom:3px;background-color:#fff;transition:.4s;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,.3)}input:checked+.slider{background-color:var(--switch-bg-checked)}input:checked+.slider:before{transform:translateX(16px)}.tool-button{background-color:transparent;border:1px solid transparent;border-radius:.5rem;padding:.5rem;cursor:pointer;transition:all .2s;color:var(--text-color)}.tool-button:hover{background-color:var(--bg-ui-hover)}.tool-button:disabled{opacity:.4;cursor:not-allowed;background-color:var(--bg-ui)}.tool-button.active{background-color:var(--bg-ui-hover);color:var(--switch-bg-checked)}.separator{height:1px;background-color:var(--border-color);margin:.25rem}.slider-input{-webkit-appearance:none;appearance:none;width:100%;flex-grow:1;height:8px;background:var(--border-color);border-radius:9999px;cursor:pointer}.slider-input::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:1rem;height:1rem;background:var(--switch-bg-checked);cursor:pointer;border-radius:50%}.slider-value-box{background-color:var(--bg-ui-hover);color:var(--text-color);font-size:.75rem;padding:.25rem .5rem;border-radius:.375rem;min-width:50px;text-align:center}.color-picker-input{-webkit-appearance:none;-moz-appearance:none;appearance:none;width:2rem;height:2rem;background-color:transparent;border:none;cursor:pointer;padding:0;border-radius:.375rem;overflow:hidden}.color-picker-input::-webkit-color-swatch{border-radius:.375rem;border:1px solid var(--border-color)}.color-picker-input::-moz-color-swatch{border-radius:.375rem;border:1px solid var(--border-color)}#selection-toolbar{position:absolute;z-index:1001;background:var(--bg-ui);padding:.35rem;border-radius:.75rem;box-shadow:0 8px 32px 0 rgba(0,0,0,.37);display:none;gap:.35rem;border:1px solid var(--border-color);transform:translate(-50%,10px);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px)}.selection-tool-btn{background-color:transparent;border:none;border-radius:.375rem;padding:.4rem;cursor:pointer;color:var(--text-color);transition:all .2s;display:flex;align-items:center;justify-content:center}.selection-tool-btn:hover{background-color:var(--bg-ui-hover)}.selection-tool-btn.active{background-color:var(--bg-ui-hover);color:var(--switch-bg-checked)}.selection-tool-btn.pinned{color:#f59e0b}.selection-tool-btn .text-red-500{color:#ef4444}.selection-tool-select{background-color:transparent;border:none;border-radius:.375rem;padding:.4rem;cursor:pointer;color:var(--text-color);font-family:'Inter',sans-serif;font-size:.8rem;outline:0;-webkit-appearance:none;-moz-appearance:none;appearance:none}.selection-tool-select:hover{background-color:var(--bg-ui-hover)}.selection-tool-select option{background-color:var(--bg-ui);color:var(--text-color);font-weight:400;font-style:normal}#text-tools-container,#grid-tools-container,#measure-tools-container{display:none;align-items:center;gap:.35rem;border-right:1px solid var(--border-color);padding-right:.35rem;margin-right:.35rem}#grid-tools-container .grid-input{background-color:transparent;border:1px solid transparent;color:var(--text-color);width:45px;font-size:.8rem;border-radius:.25rem;padding:.2rem;text-align:center}#grid-tools-container .grid-input:hover{background-color:var(--bg-ui-hover)}#text-editor{position:absolute;z-index:1002;border:none;outline:0;padding:10px;margin:0;font-family:'Inter',sans-serif;resize:none;overflow:hidden;box-sizing:border-box;line-height:1.4}.flex{display:flex}.items-center{align-items:center}.gap-2{gap:.5rem}.border-t{border-top-width:1px}.my-2{margin-top:.5rem;margin-bottom:.5rem}#confirmation-modal-overlay{top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}#confirmation-modal{background:var(--bg-ui);color:var(--text-color);padding:1.5rem 2rem;border-radius:1rem;border:1px solid var(--border-color);box-shadow:0 8px 32px 0 rgba(0,0,0,.37);text-align:center;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px)}#confirmation-modal h2{margin:0 0 .5rem;font-size:1.125rem;color:var(--text-color-strong)}#confirmation-modal p{margin:0 0 1.5rem;font-size:.875rem;color:var(--text-color-light);max-width:280px}.modal-buttons{display:flex;gap:.75rem;justify-content:center}.modal-button{padding:.5rem 1rem;border:1px solid transparent;border-radius:.375rem;font-size:.875rem;font-weight:500;cursor:pointer;transition:all .2s ease}.modal-button.confirm{background-color:#ef4444;color:#fff;border-color:transparent}.modal-button.confirm:hover{background-color:#dc2626}.modal-button.cancel{background-color:var(--bg-ui-hover);color:var(--text-color);border-color:var(--border-color)}.modal-button.cancel:hover{opacity:.8}#project-name-input{background:transparent;border:none;color:var(--text-color);font-size:.8rem;font-weight:900;padding:.5rem;width:160px;text-align:right;border-radius:.375rem;outline:0;transition:all .2s}#project-name-input:hover{background-color:var(--bg-ui-hover)}#project-name-input:focus{color:var(--text-color-strong);background-color:var(--bg-ui-hover);box-shadow:0 0 0 1px var(--switch-bg-checked)}#palette-panel{position:fixed;z-index:51;background:var(--bg-ui);border:1px solid var(--border-color);border-radius:.75rem;box-shadow:0 8px 32px 0 rgba(0,0,0,.37);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);padding:.5rem;display:flex;flex-direction:column;gap:.5rem;transform:translateY(-20px);opacity:0;transition:transform .3s ease-out,opacity .3s ease-out;pointer-events:none}#palette-panel.open{transform:translateY(0);opacity:1;pointer-events:auto}.palette-option{cursor:pointer;border-radius:.5rem;padding:4px;border:2px solid transparent;transition:border-color .2s;display:flex;gap:4px}.palette-option:hover{border-color:var(--switch-bg-checked)}.palette-color{width:24px;height:24px;border-radius:.375rem;border:1px solid rgba(0,0,0,.2)}#toolbar-color-picker-container{padding:.25rem 0;display:flex;justify-content:center}#toolbar-accent-color-picker{width:28px;height:28px;border-radius:50%}#help-modal-overlay{top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}#help-modal{background:var(--bg-ui);color:var(--text-color);padding:2rem 3rem;border-radius:1rem;border:1px solid var(--border-color);box-shadow:0 8px 32px 0 rgba(0,0,0,.37);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);width:90%;max-width:800px;height:80vh;position:relative;overflow:hidden;display:flex;flex-direction:column}#close-help-btn{position:absolute;top:1rem;right:1rem;background:transparent;border:none;color:var(--text-color-light);font-size:2rem;cursor:pointer;line-height:1}#help-modal h2{margin:0 0 1rem;font-size:1.5rem;color:var(--text-color-strong);text-align:center}.help-content{overflow-y:auto;padding-right:1rem}.help-content h3{color:var(--text-color-strong);margin-top:1.5rem;margin-bottom:.5rem;border-bottom:1px solid var(--border-color);padding-bottom:.25rem}.help-content p,.help-content li{color:var(--text-color);font-size:.9rem;line-height:1.6}.help-content ul{list-style-type:none;padding-left:0}.help-content li{padding-left:1.5rem;position:relative;margin-bottom:.5rem}.help-content li::before{content:'•';color:var(--switch-bg-checked);position:absolute;left:0}.help-content strong{color:var(--text-color-strong);font-weight:700}.footer-btn{background-color:var(--bg-ui);color:var(--text-color);width:25px;height:25px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:1px solid var(--border-color);box-shadow:0 8px 32px 0 rgba(0,0,0,.37);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);transition:all .3s ease;text-decoration:none}.footer-btn:hover{transform:scale(1.1);box-shadow:0 12px 40px 0 rgba(0,0,0,.45);color:var(--switch-bg-checked)}#toast-container{bottom:calc(1.5rem + 56px + 1rem);right:1.5rem;display:flex;flex-direction:column;gap:.75rem;align-items:flex-end}.toast-notification{background:var(--bg-ui);color:var(--text-color);padding:.75rem 1.25rem;border-radius:.75rem;border:1px solid var(--border-color);box-shadow:0 8px 32px 0 rgba(0,0,0,.37);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);opacity:0;transform:translateX(100%);animation:slideIn .3s forwards,fadeOut .3s forwards 2.7s;display:flex;align-items:center;gap:.5rem}.toast-notification.success .icon{color:#4ade80}.toast-notification.error .icon{color:#f87171}.toast-notification .icon{width:20px;height:20px}@keyframes slideIn{to{opacity:1;transform:translateX(0)}}@keyframes fadeOut{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(100%)}}@media (max-width:768px){ #left-bar .tool-button{padding:.4rem;flex-shrink:0} #left-bar svg{width:18px;height:18px}#left-bar{flex-direction:row;top:auto;bottom:.5rem;left:50%;transform:translateX(-50%);width:auto;max-width:95vw;overflow-x:auto;padding:.2rem}.separator{margin:.1rem .25rem}#context-menu{width:220px;padding:.5rem}.menu-label{font-size:.8rem}#selection-toolbar{padding:.25rem;gap:.2rem;max-width:95vw;overflow-x:auto}.selection-tool-btn{padding:.3rem}#help-modal{padding:1rem 1.5rem;width:95%;height:85vh}#help-modal h2{font-size:1.25rem}.help-content p,.help-content li{font-size:.85rem}#footer-container{bottom:calc(var(--tabs-bar-height) + .5rem);right:.5rem;gap:.5rem}#version-info{display:none}#toast-container{bottom:calc(var(--tabs-bar-height) + 4rem);right:.5rem}}

    </style>
</head>
<body>
    <div id="tabs-bar">
        <div id="app-logo" title="Moodinfinite v0.8.7" style="display: flex; align-items: center; padding: 0 0.25rem; cursor: default;">
            <img src="https://raw.githubusercontent.com/davidbrum25/moodinfinite/refs/heads/main/fav_icon_alternative.png" alt="Logo" style="width: 24px; height: 24px;">
        </div>
        <div style="width: 1px; background-color: var(--border-color); margin: 8px 4px; align-self: stretch;"></div>
        
        <button id="load-project-btn" title="Open Project (Ctrl+O)" class="tab-add-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
        </button>
        <button id="save-project-btn" title="Save Project (Ctrl+S)" class="tab-add-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
        </button>
        <div style="width: 1px; background-color: var(--border-color); margin: 8px 4px; align-self: stretch;"></div>

        <button id="add-moodinfinite-tab-btn" class="tab-add-btn" title="New Moodinfinite Board">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 15 9 5 19"></polyline></svg>
        </button>
        <button id="add-moodprompt-tab-btn" class="tab-add-btn" title="New Moodprompt File">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
        </button>
        <div style="width: 1px; background-color: var(--border-color); margin: 8px 4px; align-self: stretch;"></div>
        
        <div class="tabs-list-container">
            <div class="scroll-indicator left"></div>
            <div class="tabs-list" id="tabs-list"></div>
            <div class="scroll-indicator right"></div>
        </div>

        <div style="margin-left: auto; display: flex; align-items: center; gap: 4px;">
            <button id="save-png-btn" title="Export as PNG (Shift+S)" class="tab-add-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            </button>
            <button id="copy-to-clipboard-btn" title="Copy to Clipboard (Shift+C)" class="tab-add-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            </button>
             <button id="palette-btn" title="Color Palettes" class="tab-add-btn">
               <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-palette2" viewBox="0 0 16 16"><path d="M0 .5A.5.5 0 0 1 .5 0h5a.5.5 0 0 1 .5.5v5.277l4.147-4.131a.5.5 0 0 1 .707 0l3.535 3.536a.5.5 0 0 1 0 .708L10.261 10H15.5a.5.5 0 0 1 .5.5v5a.5.5 0 0 1-.5.5H3a3 3 0 0 1-2.121-.879A3 3 0 0 1 0 13.044m6-.21 7.328-7.3-2.829-2.828L6 7.188zM4.5 13a1.5 1.5 0 1 0-3 0 1.5 1.5 0 0 0 3 0M15 15v-4H9.258l-4.015 4zM0 .5v12.495zm0 12.495V13z"/></svg>
            </button>
        </div>
    </div>

    <div id="content-area">
        <div id="moodinfinite-container" class="tab-content">
            <canvas id="moodboard-canvas"></canvas>
            
            <textarea id="text-editor" style="display: none;"></textarea>
            <div id="left-bar">
                 <div id="toolbar-color-picker-container"><input type="color" id="toolbar-accent-color-picker" class="color-picker-input" title="Accent Color"></div><button id="eyedropper-btn" title="Eyedropper (E)" class="tool-button"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eyedropper" viewBox="0 0 16 16"><path d="M13.354.646a1.207 1.207 0 0 0-1.708 0L8.5 3.793l-.646-.647a.5.5 0 1 0-.708.708L8.293 5l-7.147 7.146A.5.5 0 0 0 1 12.5v1.793l-.854.853a.5.5 0 1 0 .708.707L1.707 15H3.5a.5.5 0 0 0 .354-.146L11 7.707l1.146 1.147a.5.5 0 0 0 .708-.708l-.647-.646 3.147-3.146a1.207 1.207 0 0 0 0-1.708zM2 12.707l7-7L10.293 7l-7 7H2z"/></svg></button><div class="separator"></div><button id="add-image-btn" title="Add Image (I)" class="tool-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 15 9 5 19"></polyline></svg></button><div class="separator"></div><button id="select-tool-btn" title="Select (A)" class="tool-button active"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"></path><path d="M13 13l6 6"></path></svg></button><button id="add-text-btn" title="Add Text (T)" class="tool-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg></button><button id="draw-btn" title="Draw (D)" class="tool-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path></svg></button><button id="add-arrow-btn" title="Add Arrow (Shift+A)" class="tool-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></button><button id="add-box-btn" title="Add Box (B)" class="tool-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg></button><button id="add-circle-btn" title="Add Circle (C)" class="tool-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle></svg></button><button id="add-measure-btn" title="Measure (M)" class="tool-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.19 5.81l-1.41-1.41a2 2 0 0 0-2.83 0L3.12 18.23a2 2 0 0 0 0 2.83l1.41 1.41a2 2 0 0 0 2.83 0L21.19 8.64a2 2 0 0 0 0-2.83z"></path><path d="m18 9 2-2"></path><path d="m2.12 21.88 5.66-5.66"></path><path d="m4.95 19.05 2.12-2.12"></path><path d="m10.58 13.41 2.12-2.12"></path></svg></button><button id="add-grid-btn" title="Add Grid (Alt+G)" class="tool-button"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="3" x2="15" y2="21"></line></svg></button><div class="separator"></div><button id="align-btn" title="Auto Align Selection (Ctrl+Shift+A)" class="tool-button" disabled><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg></button>
                <div class="separator"></div>
                <button id="open-help-btn" title="Help" class="tool-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                </button>
            </div>
            <div id="selection-toolbar">
                <div id="item-color-tool-container" style="display: none; align-items: center; gap: 0.35rem; border-right: 1px solid var(--border-color); padding-right: 0.35rem; margin-right: 0.35rem;">
                    <input type="color" id="item-color-picker" class="color-picker-input" title="Item Color" style="width: 28px; height: 28px;">
                </div>
                <div id="measure-tools-container" style="display: none; align-items: center; gap: 0.35rem; border-right: 1px solid var(--border-color); padding-right: 0.35rem; margin-right: 0.35rem;">
                    <select id="measure-unit-select" class="selection-tool-select" title="Measurement Unit">
                        <option value="px">Pixels (px)</option>
                        <option value="cm">Centimeters (cm)</option>
                        <option value="in">Inches (in)</option>
                    </select>
                </div>
                <div id="text-tools-container"><select id="font-family-select" class="selection-tool-select" title="Font Family"><option value="Inter">Inter</option><option value="Roboto">Roboto</option><option value="Lato">Lato</option><option value="Montserrat">Montserrat</option><option value="Oswald">Oswald</option><option value="Nunito">Nunito</option><option value="Merriweather">Merriweather</option><option value="Playfair Display">Playfair</option><option value="Source Code Pro">Code</option></select><button id="text-align-left-btn" class="selection-tool-btn" title="Align Left"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="17" y1="14" x2="3" y2="14"></line><line x1="21" y1="18" x2="3" y2="18"></line></svg></button><button id="text-align-center-btn" class="selection-tool-btn" title="Align Center"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="10" x2="6" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="18" y1="14" x2="6" y2="14"></line><line x1="21" y1="18" x2="3" y2="18"></line></svg></button><button id="text-align-right-btn" class="selection-tool-btn" title="Align Right"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="21" y1="10" x2="7" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="7" y2="14"></line><line x1="21" y1="18" x2="3" y2="18"></line></svg></button><button id="text-style-bold-btn" class="selection-tool-btn" title="Bold"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path></svg></button><button id="text-style-italic-btn" class="selection-tool-btn" title="Italic"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="4" x2="10" y2="4"></line><line x1="14" y1="20" x2="5" y2="20"></line><line x1="15" y1="4" x2="9" y2="20"></line></svg></button></div><div id="grid-tools-container"><label for="grid-rows-input" class="selection-tool-btn" title="Rows"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></label><input type="number" id="grid-rows-input" class="grid-input" min="1"><label for="grid-cols-input" class="selection-tool-btn" title="Columns"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="3" x2="12" y2="21"></line><line x1="6" y1="3" x2="6" y2="21"></line><line x1="18" y1="3" x2="18" y2="21"></line></svg></label><input type="number" id="grid-cols-input" class="grid-input" min="1"></div><button id="toggle-box-style-btn" class="selection-tool-btn" title="Toggle Box Style"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg></button><button id="group-btn" class="selection-tool-btn" title="Group (Ctrl+G)"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="8" width="12" height="12" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button><button id="ungroup-btn" class="selection-tool-btn" title="Ungroup (Ctrl+Shift+G)"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="8" width="12" height="12" rx="2" ry="2" stroke-dasharray="2 2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2v2"></path></svg></button><button id="bring-front-btn" class="selection-tool-btn" title="Bring to Front (Home)"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M21 21V8a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v13"/></svg></button><button id="send-back-btn" class="selection-tool-btn" title="Send to Back (End)"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-1"/><path d="M8 22v-4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v4"/></svg></button><button id="scale-btn" class="selection-tool-btn" title="Scale (S)"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 21l-6-6m6 6v-4m0 4h-4"></path><path d="M3 3l6 6m-6-6v4m0-4h4"></path></svg></button><button id="rotate-btn" class="selection-tool-btn" title="Rotate (R)"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg></button><button id="flip-horizontal-btn" class="selection-tool-btn" title="Flip Horizontal (H)"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="8 18 12 14 8 10"></polyline><polyline points="16 18 12 14 16 10"></polyline><line x1="12" y1="3" x2="12" y2="21"></line></svg></button><button id="flip-vertical-btn" class="selection-tool-btn" title="Flip Vertical (V)"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 16 14 12 10 16"></polyline><polyline points="18 8 14 12 10 8"></polyline><line x1="21" y1="12" x2="3" y2="12"></line></svg></button><button id="pin-btn" class="selection-tool-btn" title="Pin (P)"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.05 5A5 5 0 0 1 19 8.95M15.05 1A9 9 0 0 1 23 8.94m-1 7.05A5 5 0 0 1 18 19.05M16 13l-6 6-4-4-6-6"></path></svg></button><button id="delete-selection-btn" class="selection-tool-btn" title="Delete (Del)"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
            </div>
        </div>
        
        <div id="moodprompt-container" class="tab-content" style="display: none;">
            </div>
    </div>
    
    <input type="file" id="image-input" accept="image/png, image/jpeg, image/gif, image/svg+xml, image/webp" style="display: none;" multiple>
    <input type="file" id="project-input" accept=".json, .mood" style="display: none;">
    <input type="file" id="prompt-image-input" accept="image/png, image/jpeg, image/webp" style="display: none;">

    <div id="context-menu">
        <div class="menu-item"><label class="menu-label">Colors</label><div class="flex items-center gap-2"><input type="color" id="bg-color-picker" class="color-picker-input" value="#0d0d0d" title="Background Color"><input type="color" id="accent-color-picker" class="color-picker-input" value="#429eff" title="Accent Color"><input type="color" id="grid-color-picker" class="color-picker-input" value="#f9f8f6" title="Grid Color"></div></div><div class="menu-item"><label for="drop-shadow-toggle" class="menu-label">Drop Shadow</label><label class="switch"><input type="checkbox" id="drop-shadow-toggle" checked><span class="slider"></span></label></div><div class="menu-item"><label for="show-notifications-toggle" class="menu-label">Show Notifications</label><label class="switch"><input type="checkbox" id="show-notifications-toggle" checked><span class="slider"></span></label></div><div class="border-t my-2" id="opacity-separator" style="border-color:var(--border-color);display:none"></div><div class="menu-item" id="opacity-slider-container" style="display:none"><label for="item-opacity-slider" class="menu-label">Opacity</label><div class="flex items-center gap-2" style="width:60%"><input type="range" id="item-opacity-slider" min="0.05" max="1" step="0.05" value="1" class="slider-input"><div id="item-opacity-value" class="slider-value-box">100%</div></div></div><div class="border-t my-2" style="border-color:var(--border-color)"></div><div class="menu-item"><label for="show-grid-toggle" class="menu-label">Show Grid</label><label class="switch"><input type="checkbox" id="show-grid-toggle" checked><span class="slider"></span></label></div><div class="menu-item"><label for="snap-grid-toggle" class="menu-label">Snap to Grid</label><label class="switch"><input type="checkbox" id="snap-grid-toggle" checked><span class="slider"></span></label></div><div class="menu-item"><label for="grid-opacity-slider" class="menu-label">Grid Opacity</label><div class="flex items-center gap-2" style="width:60%"><input type="range" id="grid-opacity-slider" min="0" max="1" step="0.05" value="0.05" class="slider-input"><div id="grid-opacity-value" class="slider-value-box">5%</div></div></div><div class="menu-item"><label for="grid-size-slider" class="menu-label">Grid Size</label><div class="flex items-center gap-2" style="width:60%"><input type="range" id="grid-size-slider" min="10" max="200" value="50" class="slider-input"><div id="grid-size-value" class="slider-value-box">50px</div></div></div><div class="border-t my-2" id="download-separator" style="border-color:var(--border-color);display:none"></div><div class="menu-item" id="download-image-btn" style="display:none"><span class="menu-label">Download Source</span><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></div><div class="border-t my-2" id="delete-separator" style="border-color:var(--border-color)"></div><div class="menu-item" id="delete-item-btn"><span class="menu-label text-red-500">Delete Selected</span><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></div>
    </div>
    
    <div id="tab-context-menu">
        <div class="menu-item" id="rename-tab-btn"><span class="menu-label">Rename</span></div>
        <div class="menu-item" id="close-context-tab-btn"><span class="menu-label text-red-500">Close Tab</span></div>
    </div>

    <div id="palette-panel"></div>
    <div id="confirmation-modal-overlay">
        <div id="confirmation-modal"><h2>Create New Board?</h2><p>All unsaved changes will be lost. Are you sure you want to continue?</p><div class="modal-buttons"><button id="cancel-new-btn" class="modal-button cancel">Cancel</button><button id="confirm-new-btn" class="modal-button confirm">Yes, Clear Board</button></div></div>
    </div>
    <div id="help-modal-overlay">
        <div id="help-modal"><button id="close-help-btn">&times;</button><img src="https://github.com/davidbrum25/moodinfinite/blob/main/_branding/_png/moodinfinite__Logotipo_alpha.png?raw=true" alt="Moodinfinite Logo" style="width: 27vh;height: 9vh;margin: 0 auto 1rem;"><h2>Moodinfinite Help</h2><div class="help-content"><h3>Welcome!</h3><p>Moodinfinite is a digital canvas for your ideas. Add images, text, arrows, and more to create moodboards, brainstorm, or organize your thoughts.</p><h3>Core Concepts</h3><ul><li><strong>Panning & Zooming:</strong> On Desktop, use the mouse wheel to zoom and middle-click (or Space + left-click) to pan. On Touch devices, <strong>pinch with two fingers</strong> to zoom and <strong>drag with two fingers</strong> to pan.</li><li><strong>Context Menu:</strong> Right-click on Desktop. <strong>Long press</strong> on a Touch device.</li><li><strong>Selecting:</strong> Tap or Click on an item to select it. Hold <strong>Shift</strong> and click to select multiple items. Click and drag on an empty area to create a selection box.</li><li><strong>Deselect:</strong> Press <strong>Escape</strong> to clear your current selection.</li></ul><h3>Tools & Hotkeys</h3><ul><li><strong>Select (A):</strong> The default tool for selecting, moving, and interacting with items.</li><li><strong>Add Image (I):</strong> Opens a file dialog to add images. You can also paste images directly or drag-and-drop them onto the canvas.</li><li><strong>Add Text (T):</strong> Tap and drag to create a text box. Double-tap an existing text box to edit it. Finish editing with <strong>Ctrl+Enter</strong>.</li><li><strong>Add Arrow (Shift+A):</strong> Tap and drag to draw an arrow. Hold <strong>Shift</strong> while drawing to snap to 45-degree angles.</li><li><strong>Add Box (B):</strong> Tap and drag to create a colored rectangle.</li><li><strong>Add Grid (Alt+G):</strong> Tap and drag to create a grid. Adjust rows and columns from the selection toolbar.</li><li><strong>Draw (D):</strong> Freehand drawing tool.</li><li><strong>Eyedropper (E):</strong> Pick a color from the canvas to set as your current accent color.</li></ul><h3>Item Manipulation</h3><p>When you select an item, a floating toolbar appears with context-specific actions.</p><ul><li><strong>Layering:</strong> Bring an item to the very front with <strong>Home</strong> or send it to the very back with <strong>End</strong>. Move one layer at a time with <strong>Page Up</strong> and <strong>Page Down</strong>.</li><li><strong>Grouping:</strong> Select multiple items and press <strong>Ctrl+G</strong> to group them. A group can be moved, rotated, and scaled as a single object.</li><li><strong>Ungrouping:</strong> Select a group and press <strong>Ctrl+Shift+G</strong> to break it back into its individual items.</li><li><strong>Scale (S):</strong> With a single item selected, press <strong>S</strong> to activate scale mode. Drag the handle that appears on the bottom-right corner. Hold <strong>Shift</strong> while scaling to maintain the original aspect ratio.</li><li><strong>Rotate (R):</strong> With a single item selected, press <strong>R</strong> to activate rotate mode. Drag the handle that appears on the top. Hold <strong>Shift</strong> to snap rotation to 15-degree increments.</li><li><strong>Flip Horizontal (H):</strong> Flips the selected item(s) horizontally.</li><li><strong>Flip Vertical (V):</strong> Flips the selected item(s) vertically.</li><li><strong>Pin (P):</strong> Lock an item in place to prevent accidental movement or editing.</li><li><strong>Delete (Del / Backspace):</strong> Remove the selected item(s).</li><li><strong>Auto Align (Ctrl+Shift+A):</strong> Neatly arranges two or more selected items into a grid.</li></ul><h3>General Hotkeys</h3><ul><li><strong>New Board:</strong> Shift+N</li><li><strong>Open Project:</strong> Ctrl+O</li><li><strong>Save Project:</strong> Ctrl+S</li><li><strong>Export as PNG:</strong> Shift+S</li><li><strong>Copy:</strong> Ctrl+C</li><li><strong>Cut:</strong> Ctrl+X</li><li><strong>Paste:</strong> Ctrl+V</li><li><strong>Duplicate:</strong> Ctrl+D</li><li><strong>Undo:</strong> Ctrl+Z</li><li><strong>Redo:</strong> Ctrl+Shift+Z</li><li><strong>Select All:</strong> Ctrl+A</li><li><strong>Invert Selection:</strong> Ctrl+I</li><li><strong>Toggle Background Grid:</strong> G</li></ul><h3>Credits</h3><p style="line-height:1.8">Made by H. David Brum<br><a href="mailto:davidbrum@gmail.com" target="_blank" style="color:var(--switch-bg-checked);text-decoration:none">davidbrum@gmail.com</a><br><a href="https://linktr.ee/davidbrum" target="_blank" style="color:var(--switch-bg-checked);text-decoration:none">linktr.ee/davidbrum</a></p></div></div>
    </div>
    <div id="footer-container" style="position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 4999; display: flex; align-items: center; gap: 0.75rem;">
        <div id="version-info" style="font-size: 0.75rem; color: var(--text-color-light); opacity: 0.5; pointer-events: none;">
            MOODinfinite Current stable version: v0.8.7
        </div>
        <a href="https://www.patreon.com/cw/bdvd" target="_blank" class="footer-btn" title="Support on Patreon"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" style="width:55%"><path d="M15.48 2.49C10.97 2.49 7.32 6.14 7.32 10.65C7.32 15.16 10.97 18.81 15.48 18.81C19.99 18.81 23.64 15.16 23.64 10.65C23.64 6.14 19.99 2.49 15.48 2.49ZM0.36 2.49V18.81H4.2V2.49H0.36Z"/></svg></a>
        <a href="https://linktr.ee/davidbrum" target="_blank" class="footer-btn" title="H. David Brum Links"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link" style="width:60%"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg></a>
        <a href="https://github.com/davidbrum25/moodinfinite" target="_blank" class="footer-btn" title="View on GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="width:60%"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.91 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg></a>
    </div>
    <div id="toast-container"></div>

    <script>
        // --- TABS & PROJECT MANAGEMENT ---
        let projects = [];
        let activeProjectId = null;

        const tabsBar = document.getElementById('tabs-bar');
        const tabsList = document.getElementById('tabs-list');
        const addMoodinfiniteTabBtn = document.getElementById('add-moodinfinite-tab-btn');
        const addMoodpromptTabBtn = document.getElementById('add-moodprompt-tab-btn');
        const moodinfiniteContainer = document.getElementById('moodinfinite-container');
        const moodpromptContainer = document.getElementById('moodprompt-container');
        const promptImageInput = document.getElementById('prompt-image-input');
        
        const leftScrollIndicator = document.querySelector('.tabs-list-container .scroll-indicator.left');
        const rightScrollIndicator = document.querySelector('.tabs-list-container .scroll-indicator.right');

        const genericIcon = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.69l.56 2.83 2.13.23-1.63 1.49.5 2.17-1.92-1.12-1.92 1.12.5-2.17-1.63-1.49 2.13.23.56-2.83M5 19.42l.62-3.13 2.37-.26-1.82-1.65.55-2.41-2.14 1.24-2.14-1.24.55 2.41-1.82 1.65 2.37.26.62 3.13M19 19.42l.62-3.13 2.37-.26-1.82-1.65.55-2.41-2.14 1.24-2.14-1.24.55 2.41-1.82 1.65 2.37.26.62 3.13z"></path></svg>`;
        const platformData = {
            higgsfield: { name: 'Higgsfield', icon: genericIcon },
            openai_sora: { name: 'OpenAI Sora', icon: genericIcon },
            midjourney: { name: 'Midjourney', icon: `<svg viewBox="0 0 100 100"><path fill="currentColor" d="M50,15 L15,85 L85,85 L50,15 Z M50,35 L35,75 L65,75 L50,35 Z"></path></svg>` },
            wanz_5: { name: 'Wan2.5', icon: genericIcon },
            wanz_2: { name: 'Wan2.2', icon: genericIcon },
            minimax: { name: 'Minimax', icon: genericIcon },
            seedance: { name: 'Seedance', icon: genericIcon },
            kling: { name: 'Kling', icon: genericIcon },
            google_veo: { name: 'Google Veo', icon: genericIcon },
            others: { name: '- Others', icon: genericIcon }
        };

        function updateScrollIndicators() {
            if (!tabsList) return;
            const hasOverflow = tabsList.scrollWidth > tabsList.clientWidth;
            const scrollBuffer = 1;
            if (hasOverflow && tabsList.scrollLeft > scrollBuffer) {
                leftScrollIndicator.classList.add('visible');
            } else {
                leftScrollIndicator.classList.remove('visible');
            }
            if (hasOverflow && tabsList.scrollLeft < (tabsList.scrollWidth - tabsList.clientWidth - scrollBuffer)) {
                rightScrollIndicator.classList.add('visible');
            } else {
                rightScrollIndicator.classList.remove('visible');
            }
        }

        function createNewProject(type) {
            const newId = Date.now();
            let newProject;
            if (type === 'moodinfinite') {
                const projectCount = projects.filter(p => p.type === 'moodinfinite').length;
                newProject = {
                    id: newId,
                    type: 'moodinfinite',
                    name: `Board ${projectCount + 1}`,
                    data: { 
                        items: [],
                        cameraOffset: { x: window.innerWidth / 2, y: (window.innerHeight - 48) / 2 },
                        cameraZoom: 1,
                        historyStack: [],
                        historyIndex: -1,
                        canvasBackgroundColor: '#0d0d0d',
                        accentColor: '#429eff',
                        gridColor: '#f9f8f6'
                    }
                };
            } else {
                const projectCount = projects.filter(p => p.type === 'moodprompt').length;
                newProject = {
                    id: newId,
                    type: 'moodprompt',
                    name: `Prompts ${projectCount + 1}`,
                    data: {
                        prompts: [],
                        canvasBackgroundColor: '#0d0d0d',
                    }
                };
            }
            projects.push(newProject);
            renderTabs();
            switchTab(newId);
        }

        function switchTab(projectId) {
            if (activeProjectId === projectId) return; 

            if (activeProjectId) {
                const currentProject = projects.find(p => p.id === activeProjectId);
                if (currentProject && currentProject.type === 'moodinfinite') {
                    currentProject.data.items = items;
                    currentProject.data.cameraOffset = cameraOffset;
                    currentProject.data.cameraZoom = cameraZoom;
                    currentProject.data.historyStack = historyStack;
                    currentProject.data.historyIndex = historyIndex;
                }
            }
            
            activeProjectId = projectId;
            const newActiveProject = projects.find(p => p.id === projectId);

            if (!newActiveProject) return; 
            
            canvasBackgroundColor = newActiveProject.data.canvasBackgroundColor;

            if (newActiveProject.type === 'moodinfinite') {
                items = newActiveProject.data.items;
                cameraOffset = newActiveProject.data.cameraOffset;
                cameraZoom = newActiveProject.data.cameraZoom;
                historyStack = newActiveProject.data.historyStack;
                historyIndex = newActiveProject.data.historyIndex;
                currentProjectName = newActiveProject.name;
                accentColor = newActiveProject.data.accentColor;
                gridColor = newActiveProject.data.gridColor;
                moodinfiniteContainer.style.display = 'block';
                moodpromptContainer.style.display = 'none';
                resizeCanvas();
            } else {
                moodinfiniteContainer.style.display = 'none';
                moodpromptContainer.style.display = 'block';
                renderMoodpromptView(newActiveProject);
            }
            
            applySettingsToUI(); 

            document.querySelectorAll('.tab-item').forEach(t => {
                t.classList.toggle('active', t.dataset.id == projectId);
            });
        }
        
        function closeTab(projectId, event) {
            if (event) event.stopPropagation();
            const index = projects.findIndex(p => p.id === projectId);
            if (index > -1) {
                const wasActive = activeProjectId === projectId;
                projects.splice(index, 1);
                if (wasActive) {
                    if (projects.length > 0) {
                        const newActiveIndex = Math.max(0, index - 1);
                        activeProjectId = null;
                        switchTab(projects[newActiveIndex].id);
                    } else {
                        createNewProject('moodinfinite');
                        return;
                    }
                }
                renderTabs();
            }
        }
        
        function updateTabName(projectId, newName) {
             const project = projects.find(p => p.id === projectId);
             if (project) {
                 project.name = newName;
                 if (project.type === 'moodinfinite' && project.id === activeProjectId) {
                     currentProjectName = newName;
                 }
             }
        }

        function renderTabs() {
            const currentActive = activeProjectId;
            tabsList.innerHTML = '';
            projects.forEach(project => {
                const tab = document.createElement('div');
                tab.className = 'tab-item';
                tab.classList.toggle('active', project.id === currentActive);
                tab.dataset.id = project.id;
                tab.draggable = true;

                const icon = document.createElement('span');
                icon.innerHTML = project.type === 'moodinfinite' 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 15 9 5 19"></polyline></svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>`;
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'tab-name';
                nameSpan.textContent = project.name;

                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'tab-name-input';
                nameInput.value = project.name;
                
                const closeBtn = document.createElement('button');
                closeBtn.className = 'tab-close-btn';
                closeBtn.innerHTML = '&times;';
                closeBtn.onclick = (e) => closeTab(project.id, e);

                tab.appendChild(icon);
                tab.appendChild(nameSpan);
                tab.appendChild(nameInput);
                tab.appendChild(closeBtn);
                
                let clickTimeout = null;
                const startEditing = () => {
                    clearTimeout(clickTimeout);
                    nameSpan.style.display = 'none';
                    nameInput.style.display = 'inline';
                    nameInput.focus();
                    nameInput.select();
                };

                const finishEditing = () => {
                    const newName = nameInput.value.trim();
                    if (newName && newName !== project.name) {
                        updateTabName(project.id, newName);
                        nameSpan.textContent = newName;
                    } else {
                        nameInput.value = project.name;
                        nameSpan.textContent = project.name;
                    }
                    nameInput.style.display = 'none';
                    nameSpan.style.display = 'inline';
                };
                
                tab.addEventListener('click', (e) => {
                    if (e.target === nameInput) return;
                    clearTimeout(clickTimeout);
                    clickTimeout = setTimeout(() => { switchTab(project.id); }, 200);
                });

                tab.addEventListener('dblclick', (e) => {
                    if (e.target !== nameInput) { clearTimeout(clickTimeout); startEditing(); }
                });
                
                nameInput.addEventListener('blur', finishEditing);
                nameInput.addEventListener('keydown', e => {
                    if (e.key === 'Enter') nameInput.blur();
                    else if (e.key === 'Escape') { nameInput.value = project.name; nameInput.blur(); }
                });
                nameInput.onclick = e => e.stopPropagation();

                tab.addEventListener('contextmenu', e => {
                    e.preventDefault();
                    document.querySelectorAll('#context-menu, #tab-context-menu').forEach(m => m.style.display = 'none');
                    const menu = document.getElementById('tab-context-menu');
                    menu.dataset.tabId = project.id;
                    showAndPositionMenu(menu, e);
                });
                
                tab.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', project.id.toString());
                    e.dataTransfer.effectAllowed = 'move';
                    setTimeout(() => { tab.classList.add('dragging'); }, 0);
                });

                tab.addEventListener('dragend', () => {
                    const draggingElem = document.querySelector('.tab-item.dragging');
                    if (draggingElem) { draggingElem.classList.remove('dragging'); }
                });

                tabsList.appendChild(tab);
            });
            setTimeout(updateScrollIndicators, 0);
        }
        
        function renderMoodpromptView(project) {
            moodpromptContainer.innerHTML = '';
            const promptList = document.createElement('div');
            promptList.className = 'prompt-list';
            
            project.data.prompts.forEach((prompt, index) => { promptList.appendChild(createPromptCard(project, prompt, index)); });
            
            promptList.addEventListener('dragover', (e) => { e.preventDefault(); });

            promptList.addEventListener('drop', (e) => {
                e.preventDefault();
                const oldIndex = parseInt(e.dataTransfer.getData('text/plain'), 10);
                const dropTargetCard = e.target.closest('.prompt-card');
                if (!dropTargetCard) return;

                const allCards = Array.from(promptList.querySelectorAll('.prompt-card'));
                const newIndex = allCards.indexOf(dropTargetCard);

                if (oldIndex !== newIndex) {
                    const [movedPrompt] = project.data.prompts.splice(oldIndex, 1);
                    project.data.prompts.splice(newIndex, 0, movedPrompt);
                    renderMoodpromptView(project);
                }
            });

            moodpromptContainer.appendChild(promptList);

            const addBtn = document.createElement('button');
            addBtn.id = 'add-prompt-btn';
            addBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Add New Prompt`;
            addBtn.onclick = () => {
                project.data.prompts.push({ id: Date.now(), title: 'New Prompt', platform: 'midjourney', mediaType: 'image', image1: null, image2: null, text: '' });
                renderMoodpromptView(project);
            };
            moodpromptContainer.appendChild(addBtn);
        }

        function createPromptCard(project, prompt, index) {
            const card = document.createElement('div');
            card.className = 'prompt-card';
            card.draggable = true;

            card.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', index); card.classList.add('dragging'); });
            card.addEventListener('dragend', () => { card.classList.remove('dragging'); });

            const header = document.createElement('div');
            header.className = 'prompt-header';
            const titleContainer = document.createElement('div');
            titleContainer.style.display = 'flex';
            titleContainer.style.alignItems = 'center';
            titleContainer.style.width = '100%';
            const numberSpan = document.createElement('span');
            numberSpan.className = 'prompt-number';
            numberSpan.textContent = `${index + 1}.`;
            const titleInput = document.createElement('input');
            titleInput.type = 'text';
            titleInput.className = 'prompt-title-input';
            titleInput.value = prompt.title;
            titleInput.onchange = (e) => prompt.title = e.target.value;
            titleContainer.append(numberSpan, titleInput);
            const controls = document.createElement('div');
            controls.className = 'prompt-controls';
            const platformSelectWrapper = document.createElement('div');
            platformSelectWrapper.className = 'platform-select-wrapper';
            const platformSelect = document.createElement('select');
            platformSelect.className = 'platform-select';
            Object.keys(platformData).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = platformData[key].name;
                if (key === prompt.platform) option.selected = true;
                platformSelect.appendChild(option);
            });
            const updateIcon = () => { if (platformData[platformSelect.value]) { platformSelectWrapper.style.setProperty('--icon-url', `url('data:image/svg+xml;utf8,${encodeURIComponent(platformData[platformSelect.value].icon)}')`); } };
            updateIcon();
            platformSelect.onchange = (e) => { prompt.platform = e.target.value; updateIcon(); };
            platformSelectWrapper.appendChild(platformSelect);
            const mediaToggle = document.createElement('div');
            mediaToggle.className = 'media-type-toggle';
            const imgBtn = document.createElement('button');
            imgBtn.textContent = 'Image';
            imgBtn.className = `media-type-btn ${prompt.mediaType === 'image' ? 'active' : ''}`;
            const vidBtn = document.createElement('button');
            vidBtn.textContent = 'Video';
            vidBtn.className = `media-type-btn ${prompt.mediaType === 'video' ? 'active' : ''}`;
            mediaToggle.append(imgBtn, vidBtn);
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'tab-add-btn prompt-delete-btn';
            deleteBtn.title = 'Delete Prompt';
            deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
            deleteBtn.onclick = () => { project.data.prompts.splice(index, 1); renderMoodpromptView(project); };
            const body = document.createElement('div');
            body.className = 'prompt-body';
            const imagesContainer = document.createElement('div');
            imagesContainer.className = 'prompt-images';
            const imgSlot1 = createImageSlot(project, prompt, 1);
            const imgSlot2 = createImageSlot(project, prompt, 2);
            imagesContainer.append(imgSlot1, imgSlot2);
            const promptText = document.createElement('textarea');
            promptText.className = 'prompt-text-area';
            promptText.placeholder = 'Enter your AI prompt here...';
            promptText.value = prompt.text;
            promptText.onchange = (e) => prompt.text = e.target.value;
            const setMediaType = (type) => {
                prompt.mediaType = type;
                imgBtn.classList.toggle('active', type === 'image');
                vidBtn.classList.toggle('active', type === 'video');
                imgSlot2.style.display = type === 'video' ? 'flex' : 'none';
            };
            imgBtn.onclick = () => setMediaType('image');
            vidBtn.onclick = () => setMediaType('video');
            setMediaType(prompt.mediaType);
            controls.append(platformSelectWrapper, mediaToggle, deleteBtn);
            header.append(titleContainer, controls);
            body.append(imagesContainer, promptText);
            card.append(header, body);
            return card;
        }

        function createImageSlot(project, prompt, slotNumber) {
            const slot = document.createElement('div');
            slot.className = 'image-upload-slot';
            const prop = `image${slotNumber}`;
            if (prompt[prop]) {
                const img = document.createElement('img');
                img.src = prompt[prop];
                slot.appendChild(img);
            } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'placeholder';
                placeholder.textContent = `+ Add Image ${slotNumber}`;
                slot.appendChild(placeholder);
            }
            slot.onclick = () => {
                promptImageInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (readEvent) => { prompt[prop] = readEvent.target.result; renderMoodpromptView(project); };
                        reader.readAsDataURL(file);
                    }
                };
                promptImageInput.click();
            };
            return slot;
        }

        addMoodinfiniteTabBtn.onclick = () => createNewProject('moodinfinite');
        addMoodpromptTabBtn.onclick = () => createNewProject('moodprompt');

        const canvas = document.getElementById('moodboard-canvas');
        const ctx = canvas.getContext('2d');
        const imageInput = document.getElementById('image-input');
        const projectInput = document.getElementById('project-input');
        const addImageBtn = document.getElementById('add-image-btn');
        const addTextBtn = document.getElementById('add-text-btn');
        const addArrowBtn = document.getElementById('add-arrow-btn');
        const addBoxBtn = document.getElementById('add-box-btn');
        const addCircleBtn = document.getElementById('add-circle-btn');
        const addMeasureBtn = document.getElementById('add-measure-btn');
        const addGridBtn = document.getElementById('add-grid-btn');
        const drawBtn = document.getElementById('draw-btn');
        const alignBtn = document.getElementById('align-btn');
        const contextMenu = document.getElementById('context-menu');
        const tabContextMenu = document.getElementById('tab-context-menu');
        const showGridToggle = document.getElementById('show-grid-toggle');
        const snapGridToggle = document.getElementById('snap-grid-toggle');
        const dropShadowToggle = document.getElementById('drop-shadow-toggle');
        const showNotificationsToggle = document.getElementById('show-notifications-toggle');
        const gridSizeSlider = document.getElementById('grid-size-slider');
        const gridSizeValue = document.getElementById('grid-size-value');
        const gridOpacitySlider = document.getElementById('grid-opacity-slider');
        const gridOpacityValue = document.getElementById('grid-opacity-value');
        const deleteItemBtn = document.getElementById('delete-item-btn');
        const savePngBtn = document.getElementById('save-png-btn');
        const saveProjectBtn = document.getElementById('save-project-btn');
        const loadProjectBtn = document.getElementById('load-project-btn');
        const bgColorPicker = document.getElementById('bg-color-picker');
        const accentColorPicker = document.getElementById('accent-color-picker');
        const gridColorPicker = document.getElementById('grid-color-picker');
        const toolbarAccentColorPicker = document.getElementById('toolbar-accent-color-picker');
        const textEditor = document.getElementById('text-editor');
        const itemColorToolContainer = document.getElementById('item-color-tool-container');
        const itemColorPicker = document.getElementById('item-color-picker');
        const selectionToolbar = document.getElementById('selection-toolbar');
        const toggleBoxStyleBtn = document.getElementById('toggle-box-style-btn');
        const scaleBtn = document.getElementById('scale-btn');
        const rotateBtn = document.getElementById('rotate-btn');
        const flipHorizontalBtn = document.getElementById('flip-horizontal-btn');
        const flipVerticalBtn = document.getElementById('flip-vertical-btn');
        const pinBtn = document.getElementById('pin-btn');
        const deleteSelectionBtn = document.getElementById('delete-selection-btn');
        const bringFrontBtn = document.getElementById('bring-front-btn');
        const sendBackBtn = document.getElementById('send-back-btn');
        const confirmationModalOverlay = document.getElementById('confirmation-modal-overlay');
        const confirmNewBtn = document.getElementById('confirm-new-btn');
        const cancelNewBtn = document.getElementById('cancel-new-btn');
        const opacitySliderContainer = document.getElementById('opacity-slider-container');
        const opacitySeparator = document.getElementById('opacity-separator');
        const itemOpacitySlider = document.getElementById('item-opacity-slider');
        const itemOpacityValue = document.getElementById('item-opacity-value');
        const paletteBtn = document.getElementById('palette-btn');
        const palettePanel = document.getElementById('palette-panel');
        const eyedropperBtn = document.getElementById('eyedropper-btn');
        const groupBtn = document.getElementById('group-btn');
        const ungroupBtn = document.getElementById('ungroup-btn');
        const textToolsContainer = document.getElementById('text-tools-container');
        const gridToolsContainer = document.getElementById('grid-tools-container');
        const measureToolsContainer = document.getElementById('measure-tools-container');
        const gridRowsInput = document.getElementById('grid-rows-input');
        const gridColsInput = document.getElementById('grid-cols-input');
        const measureUnitSelect = document.getElementById('measure-unit-select');
        const fontFamilySelect = document.getElementById('font-family-select');
        const textAlignLeftBtn = document.getElementById('text-align-left-btn');
        const textAlignCenterBtn = document.getElementById('text-align-center-btn');
        const textAlignRightBtn = document.getElementById('text-align-right-btn');
        const textStyleBoldBtn = document.getElementById('text-style-bold-btn');
        const textStyleItalicBtn = document.getElementById('text-style-italic-btn');
        const openHelpBtn = document.getElementById('open-help-btn');
        const helpModalOverlay = document.getElementById('help-modal-overlay');
        const closeHelpBtn = document.getElementById('close-help-btn');
        const selectToolBtn = document.getElementById('select-tool-btn');
        const downloadImageBtn = document.getElementById('download-image-btn');
        const downloadSeparator = document.getElementById('download-separator');

        let cameraOffset, cameraZoom;
        let items = [], selectedItems = []; 
        let historyStack, historyIndex;

        const MAX_ZOOM = 5, MIN_ZOOM = 0.1, SCROLL_SENSITIVITY = 0.0005;
        let isDragging = false, dragStart = { x: 0, y: 0 };
        let clipboard = [];
        let internalClipboardTimestamp = 0;
        let isMovingItems = false, moveStart = {x: 0, y: 0};
        let currentTool = null, isDrawing = false;
        let canvasBackgroundColor = '#0d0d0d', accentColor = '#429eff', gridColor = '#f9f8f6';
        let activeGizmo = null, isTransforming = false, isTransformingArrow = false;
        let transformingHandle = null, transformStart = { x: 0, y: 0 }, originalItemState = null;
        let hoveredGizmo = null, hoveredArrowHandle = null;
        let isSelectingBox = false, selectionBox = { startX: 0, startY: 0, endX: 0, endY: 0 };
        let currentlyEditingText = null;
        let showGrid = true, snapToGrid = true, showDropShadow = true, showNotifications = true;
        let gridSize = 50, gridOpacity = 0.05;
        let currentProjectName = 'moodinfinite';
        const HISTORY_LIMIT = 50;

        const colorPalettes = [
            { bg: '#0d0d0d', accent: '#429eff', grid: '#ffffff' }, { bg: '#f8f9fa', accent: '#007bff', grid: '#ced4da' },
            { bg: '#fdf6e3', accent: '#cb4b16', grid: '#93a1a1' }, { bg: '#002b36', accent: '#268bd2', grid: '#586e75' },
            { bg: '#2e3440', accent: '#88c0d0', grid: '#4c566a' }, { bg: '#282a36', accent: '#ff79c6', grid: '#44475a' },
            { bg: '#282828', accent: '#fabd2f', grid: '#504945' }, { bg: '#191724', accent: '#eb6f92', grid: '#555169' },
            { bg: '#2c3d33', accent: '#a7c957', grid: '#6a7d6d' }, { bg: '#bfbfbf', accent: '#fe345c', grid: '#000000' }
        ];

        function getDragAfterElement(container, x) {
            const draggableElements = [...container.querySelectorAll('.tab-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        function showAndPositionMenu(menu,event){menu.style.display='block';const menuWidth=menu.offsetWidth,menuHeight=menu.offsetHeight,screenWidth=window.innerWidth,screenHeight=window.innerHeight,padding=8;let left=event.clientX,top=event.clientY;if(left+menuWidth>screenWidth-padding){left=screenWidth-menuWidth-padding}if(top+menuHeight>screenHeight-padding){top=screenHeight-menuHeight-padding}left=Math.max(padding,left);top=Math.max(padding,top);menu.style.left=`${left}px`;menu.style.top=`${top}px`}
        
        function saveSettings() {
            try {
                const settings = { showGrid, snapToGrid, showDropShadow, showNotifications, gridSize, gridOpacity };
                localStorage.setItem('moodinfinite-settings', JSON.stringify(settings));
            } catch (error) { console.error("Could not save settings to localStorage:", error); }
        }

        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('moodinfinite-settings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    showGrid = settings.showGrid ?? showGrid;
                    snapToGrid = settings.snapToGrid ?? snapToGrid;
                    showDropShadow = settings.showDropShadow ?? showDropShadow;
                    showNotifications = settings.showNotifications ?? showNotifications;
                    gridSize = settings.gridSize ?? gridSize;
                    gridOpacity = settings.gridOpacity ?? gridOpacity;
                }
            } catch (error) { console.error("Could not load settings from localStorage:", error); }
        }

        function applySettingsToUI() {
            showGridToggle.checked = showGrid;
            snapGridToggle.checked = snapToGrid;
            dropShadowToggle.checked = showDropShadow;
            showNotificationsToggle.checked = showNotifications;
            gridSizeSlider.value = gridSize;
            gridSizeValue.textContent = `${gridSize}px`;
            gridOpacitySlider.value = gridOpacity;
            gridOpacityValue.textContent = `${Math.round(gridOpacity * 100)}%`;
            updateUIColors();
        }

        function setupEventListeners(){
            tabsList.addEventListener('dragover',e=>{e.preventDefault();const t=document.querySelector('.tab-item.dragging');if(!t)return;const o=getDragAfterElement(tabsList,e.clientX);if(o==null){tabsList.appendChild(t)}else{tabsList.insertBefore(t,o)}});
            tabsList.addEventListener('drop',e=>{e.preventDefault();const t=parseInt(e.dataTransfer.getData('text/plain'));if(isNaN(t))return;const o=Array.from(tabsList.querySelectorAll('.tab-item')).map(e=>parseInt(e.dataset.id));projects.sort((e,t)=>o.indexOf(e.id)-o.indexOf(t.id));renderTabs()});
            tabsList.addEventListener('wheel', e => { if (tabsList.scrollWidth <= tabsList.clientWidth || e.deltaY === 0) return; e.preventDefault(); tabsList.scrollLeft += e.deltaY; });
            tabsList.addEventListener('scroll', updateScrollIndicators);
            const tabObserver = new ResizeObserver(updateScrollIndicators);
            tabObserver.observe(tabsList);

            const copyBtn=document.getElementById('copy-to-clipboard-btn');const renameTabBtn=document.getElementById('rename-tab-btn');const closeContextTabBtn=document.getElementById('close-context-tab-btn');copyBtn.addEventListener('click',copyToClipboard);renameTabBtn.addEventListener('click',()=>{const e=tabContextMenu.dataset.tabId;if(e){const t=document.querySelector(`.tab-item[data-id='${e}']`);if(t){const e=t.querySelector('.tab-name'),o=t.querySelector('.tab-name-input');e.style.display='none';o.style.display='inline';o.focus();o.select()}}tabContextMenu.style.display='none'});closeContextTabBtn.addEventListener('click',()=>{const e=tabContextMenu.dataset.tabId;if(e){closeTab(parseInt(e))}tabContextMenu.style.display='none'});canvas.addEventListener('mousedown',onMouseDown);canvas.addEventListener('mouseup',onMouseUp);canvas.addEventListener('mousemove',onMouseMove);canvas.addEventListener('dblclick',onDoubleClick);canvas.addEventListener('wheel',e=>{e.preventDefault();adjustZoom(e,-e.deltaY*SCROLL_SENSITIVITY)});canvas.addEventListener('contextmenu',onContextMenu);canvas.addEventListener('touchstart',onTouchStart,{passive:!1});canvas.addEventListener('touchend',onTouchEnd,{passive:!1});canvas.addEventListener('touchmove',onTouchMove,{passive:!1});canvas.addEventListener('touchcancel',onTouchEnd,{passive:!1});window.addEventListener('resize',resizeCanvas);window.addEventListener('keydown',handleKeyDown);document.addEventListener('click',e=>{if(!contextMenu.contains(e.target))contextMenu.style.display='none';if(!tabContextMenu.contains(e.target))tabContextMenu.style.display='none';if(palettePanel.classList.contains('open')&&!palettePanel.contains(e.target)&&e.target!==paletteBtn&&!paletteBtn.contains(e.target)){palettePanel.classList.remove('open')}});window.addEventListener('paste',handlePaste);canvas.addEventListener('dragover',handleDragOver);canvas.addEventListener('dragleave',handleDragLeave);canvas.addEventListener('drop',handleDrop);openHelpBtn.addEventListener('click',()=>helpModalOverlay.style.display='flex');closeHelpBtn.addEventListener('click',()=>helpModalOverlay.style.display='none');helpModalOverlay.addEventListener('click',e=>{if(e.target===helpModalOverlay){helpModalOverlay.style.display='none'}});savePngBtn.addEventListener('click',saveAsPng);saveProjectBtn.addEventListener('click',saveProject);loadProjectBtn.addEventListener('click',()=>projectInput.click());paletteBtn.addEventListener('click', () => { if (palettePanel.classList.contains('open')) { palettePanel.classList.remove('open'); } else { const buttonRect = paletteBtn.getBoundingClientRect(); palettePanel.style.top = `${buttonRect.bottom + 8}px`; palettePanel.style.left = `0px`; palettePanel.classList.add('open'); const panelWidth = palettePanel.offsetWidth; const screenPadding = 8; let newLeft = buttonRect.right - panelWidth; newLeft = Math.max(screenPadding, newLeft); palettePanel.style.left = `${newLeft}px`; } });addImageBtn.addEventListener('click',()=>imageInput.click());imageInput.addEventListener('change',handleImageUpload);projectInput.addEventListener('change',handleProjectUpload);addArrowBtn.addEventListener('click',()=>setCurrentTool('arrow'));addTextBtn.addEventListener('click',()=>setCurrentTool('text'));addBoxBtn.addEventListener('click',()=>setCurrentTool('box'));addCircleBtn.addEventListener('click',()=>setCurrentTool('circle'));addMeasureBtn.addEventListener('click',()=>setCurrentTool('measure'));addGridBtn.addEventListener('click',()=>setCurrentTool('grid'));drawBtn.addEventListener('click',()=>setCurrentTool('draw'));eyedropperBtn.addEventListener('click',()=>setCurrentTool('eyedropper'));alignBtn.addEventListener('click',autoAlignSelection);selectToolBtn.addEventListener('click',()=>setCurrentTool(null));showGridToggle.addEventListener('change',e=>{showGrid=e.target.checked;saveSettings()});snapGridToggle.addEventListener('change',e=>{snapToGrid=e.target.checked;saveSettings()});dropShadowToggle.addEventListener('change',e=>{showDropShadow=e.target.checked;saveSettings()});showNotificationsToggle.addEventListener('change',e=>{showNotifications=e.target.checked;saveSettings()});gridSizeSlider.addEventListener('input',e=>{gridSize=parseInt(e.target.value);gridSizeValue.textContent=`${gridSize}px`;saveSettings()});gridOpacitySlider.addEventListener('input',e=>{gridOpacity=parseFloat(e.target.value);gridOpacityValue.textContent=`${Math.round(gridOpacity*100)}%`;saveSettings()});deleteItemBtn.addEventListener('click',deleteSelectedItems);const updateColor= (key,value) => {const proj=projects.find(p=>p.id===activeProjectId);if(proj&&(proj.type==='moodinfinite'||proj.type==='moodprompt')){proj.data[key]=value;if(key==='canvasBackgroundColor')canvasBackgroundColor=value;else if(key==='accentColor')accentColor=value;else if(key==='gridColor')gridColor=value;updateUIColors()}};bgColorPicker.addEventListener('input',e=>updateColor('canvasBackgroundColor',e.target.value));accentColorPicker.addEventListener('input',e=>updateColor('accentColor',e.target.value));toolbarAccentColorPicker.addEventListener('input',e=>updateColor('accentColor',e.target.value));gridColorPicker.addEventListener('input',e=>updateColor('gridColor',e.target.value));itemOpacitySlider.addEventListener('input',e=>{const t=parseFloat(e.target.value);selectedItems.forEach(e=>{e.opacity=t});itemOpacityValue.textContent=`${Math.round(t*100)}%`});itemOpacitySlider.addEventListener('change',()=>{saveStateForUndo()});toggleBoxStyleBtn.addEventListener('click',toggleBoxStyle);groupBtn.addEventListener('click',groupSelectedItems);ungroupBtn.addEventListener('click',ungroupSelectedItems);scaleBtn.addEventListener('click',()=>setActiveGizmo('scale'));rotateBtn.addEventListener('click',()=>setActiveGizmo('rotate'));flipHorizontalBtn.addEventListener('click',flipHorizontal);flipVerticalBtn.addEventListener('click',flipVertical);pinBtn.addEventListener('click',togglePin);deleteSelectionBtn.addEventListener('click',deleteSelectedItems);bringFrontBtn.addEventListener('click',bringSelectedToFront);sendBackBtn.addEventListener('click',sendSelectedToBack);fontFamilySelect.addEventListener('change',setTextFontFamily);textAlignLeftBtn.addEventListener('click',()=>setTextAlign('left'));textAlignCenterBtn.addEventListener('click',()=>setTextAlign('center'));textAlignRightBtn.addEventListener('click',()=>setTextAlign('right'));textStyleBoldBtn.addEventListener('click',toggleTextStyleBold);textStyleItalicBtn.addEventListener('click',toggleTextStyleItalic);gridRowsInput.addEventListener('change',e=>updateGridDimension('rows',e.target.value));gridColsInput.addEventListener('change',e=>updateGridDimension('cols',e.target.value));measureUnitSelect.addEventListener('change',updateMeasureUnit);textEditor.addEventListener('blur',finishEditingText);textEditor.addEventListener('input',autoResizeTextEditor);textEditor.addEventListener('keydown',e=>{if(e.key==='Escape'||(e.key==='Enter'&&e.ctrlKey)){e.preventDefault();finishEditingText()}});itemColorPicker.addEventListener('input',e=>{if(selectedItems.length===1&&(selectedItems[0].type==='box'||selectedItems[0].type==='circle'||selectedItems[0].type==='text'||selectedItems[0].type==='measure')){selectedItems[0].color=e.target.value}});confirmNewBtn.addEventListener('click',()=>{resetBoard();hideConfirmationModal()});cancelNewBtn.addEventListener('click',hideConfirmationModal);downloadImageBtn.addEventListener('click',downloadSourceImage)}
        function resizeCanvas(){if(!activeProjectId||projects.find(e=>e.id===activeProjectId)?.type!=='moodinfinite')return;const t=document.getElementById('content-area'),o=canvas.width,a=canvas.height,i=t.clientWidth,r=t.clientHeight;if(o===i&&a===r)return;cameraOffset.x-=(i-o)/(2*cameraZoom);cameraOffset.y-=(r-a)/(2*cameraZoom);canvas.width=i;canvas.height=r}
        function gameLoop(){draw();updateToolbarPosition();requestAnimationFrame(gameLoop)}
        function draw(){if(!activeProjectId||projects.find(e=>e.id===activeProjectId)?.type!=='moodinfinite')return;ctx.setTransform(1,0,0,1,0,0);ctx.clearRect(0,0,canvas.width,canvas.height);ctx.save();ctx.translate(canvas.width/2,canvas.height/2);ctx.scale(cameraZoom,cameraZoom);ctx.translate(-canvas.width/2+cameraOffset.x,-canvas.height/2+cameraOffset.y);if(showGrid)drawGrid();items.forEach(e=>{if(e.isHidden)return;ctx.save();ctx.globalAlpha=e.opacity??1;if(showDropShadow){ctx.shadowColor='rgba(0, 0, 0, 0.4)';ctx.shadowBlur=15/cameraZoom;ctx.shadowOffsetX=4/cameraZoom;ctx.shadowOffsetY=4/cameraZoom}if(e.type==='image'){const t=e.x+e.width/2,o=e.y+e.height/2;ctx.translate(t,o);ctx.rotate(e.rotation);ctx.scale(e.scaleX||1,e.scaleY||1);if(e.img.complete){ctx.drawImage(e.img,-e.width/2,-e.height/2,e.width,e.height)}}else if(e.type==='arrow'){drawArrow(ctx,e)}else if(e.type==='text'){drawTextItem(ctx,e)}else if(e.type==='box'){drawBoxItem(ctx,e)}else if(e.type==='circle'){drawCircleItem(ctx,e)}else if(e.type==='measure'){drawMeasureItem(ctx,e)}else if(e.type==='stroke'){drawStrokeItem(ctx,e)}else if(e.type==='grid'){drawGridItem(ctx,e)}else if(e.type==='group'){drawGroupItem(ctx,e)}ctx.restore()});selectedItems.forEach(e=>{drawSelection(e)});if(isSelectingBox)drawSelectionBox();ctx.restore()}
        function drawSelection(e){if(selectedItems.length>1){drawSelectionOutline(e);return}if((e.type==='arrow'||e.type==='measure')&&!e.isPinned){const t=8/cameraZoom,o=invertColor(canvasBackgroundColor);ctx.save();ctx.fillStyle=o;ctx.shadowColor='rgba(0, 0, 0, 0.4)';ctx.shadowBlur=4/cameraZoom;ctx.beginPath();ctx.arc(e.startX,e.startY,t,0,Math.PI*2);ctx.fill();if(hoveredArrowHandle==='start'){ctx.strokeStyle=accentColor;ctx.lineWidth=2/cameraZoom;ctx.stroke()}ctx.beginPath();ctx.arc(e.endX,e.endY,t,0,Math.PI*2);ctx.fill();if(hoveredArrowHandle==='end'){ctx.strokeStyle=accentColor;ctx.lineWidth=2/cameraZoom;ctx.stroke()}ctx.restore();return}if(e.type==='stroke'){drawSelectionOutline(e);return}ctx.save();const t=e.x+e.width/2,o=e.y+e.height/2;ctx.translate(t,o);ctx.rotate(e.rotation);ctx.strokeStyle=accentColor;ctx.lineWidth=2/cameraZoom;ctx.strokeRect(-e.width/2,-e.height/2,e.width,e.height);if(activeGizmo&&!e.isPinned){const t=invertColor(canvasBackgroundColor),o=8/cameraZoom;ctx.shadowColor='rgba(0, 0, 0, 0.4)';ctx.shadowBlur=4/cameraZoom;ctx.fillStyle=t;ctx.strokeStyle=t;if(activeGizmo==='scale'){const t=e.width/2,a=e.height/2;ctx.beginPath();ctx.arc(t,a,o,0,Math.PI*2);ctx.fill();if(hoveredGizmo==='scale'){ctx.strokeStyle=accentColor;ctx.lineWidth=2/cameraZoom;ctx.stroke()}}else if(activeGizmo==='rotate'){const t=e.width/2,a=-e.height/2,i=a-20/cameraZoom;ctx.beginPath();ctx.moveTo(t,a);ctx.lineTo(t,i);ctx.stroke();ctx.beginPath();ctx.arc(t,i,o,0,Math.PI*2);ctx.fill();if(hoveredGizmo==='rotate'){ctx.strokeStyle=accentColor;ctx.lineWidth=2/cameraZoom;ctx.stroke()}}}ctx.restore()}
        function drawSelectionOutline(e){ctx.save();const t=getItemBoundingBox(e);ctx.strokeStyle=accentColor;ctx.lineWidth=2/cameraZoom;ctx.setLineDash([6/cameraZoom,4/cameraZoom]);ctx.strokeRect(t.x,t.y,t.width,t.height);ctx.restore()}
        function drawSelectionBox(){ctx.save();ctx.fillStyle=hexToRgba(accentColor,.1);ctx.strokeStyle=accentColor;ctx.lineWidth=1/cameraZoom;const{x:e,y:t,width:o,height:a}=getNormalizedSelectionBox();ctx.fillRect(e,t,o,a);ctx.strokeRect(e,t,o,a);ctx.restore()}
        function drawGrid(){const e=(0-canvas.width/2)/cameraZoom-cameraOffset.x+canvas.width/2,t=(0-canvas.height/2)/cameraZoom-cameraOffset.y+canvas.height/2,o=(canvas.width-canvas.width/2)/cameraZoom-cameraOffset.x+canvas.width/2,a=(canvas.height-canvas.height/2)/cameraZoom-cameraOffset.y+canvas.height/2,i=Math.floor(e/gridSize)*gridSize,r=Math.floor(t/gridSize)*gridSize;ctx.save();ctx.globalAlpha=gridOpacity;ctx.beginPath();ctx.strokeStyle=gridColor;ctx.lineWidth=1/cameraZoom;for(let s=i;s<o;s+=gridSize){ctx.moveTo(s,t);ctx.lineTo(s,a)}for(let s=r;s<a;s+=gridSize){ctx.moveTo(e,s);ctx.lineTo(o,s)}ctx.stroke();ctx.restore()}
        function drawArrow(e,t){const o=10/cameraZoom,a=t.endX-t.startX,i=t.endY-t.startY,r=Math.atan2(i,a);e.save();e.beginPath();e.moveTo(t.startX,t.startY);e.lineTo(t.endX,t.endY);e.lineTo(t.endX-o*Math.cos(r-Math.PI/6),t.endY-o*Math.sin(r-Math.PI/6));e.moveTo(t.endX,t.endY);e.lineTo(t.endX-o*Math.cos(r+Math.PI/6),t.endY-o*Math.sin(r+Math.PI/6));e.strokeStyle=t.color||accentColor;e.lineWidth=3/cameraZoom;e.stroke();e.restore()}
        function drawTextItem(e,t){e.save();const o=t.x+t.width/2,a=t.y+t.height/2;e.translate(o,a);e.rotate(t.rotation);e.scale(t.scaleX||1,t.scaleY||1);e.globalAlpha=(t.opacity??1)*.05;e.fillStyle=t.color;e.fillRect(-t.width/2,-t.height/2,t.width,t.height);e.globalAlpha=t.opacity??1;e.fillStyle=t.color;const i=t.fontStyle||'normal',r=t.fontWeight||'bold',s=t.fontFamily||'Inter';e.font=`${i} ${r} ${t.fontSize}px '${s}', sans-serif`;e.textAlign=t.textAlign||'center';e.textBaseline='middle';const n=t.text.split(' '),l=[],c='';let d=c;for(let o=0;o<n.length;o++){const a=d+n[o]+' ';if(e.measureText(a).width>t.width-20&&o>0){l.push(d.trim());d=n[o]+' '}else{d=a}}l.push(d.trim());const h=t.fontSize*1.4;let p=-l.length*h/2+h/2,m=0;if(e.textAlign==='left'){m=-t.width/2+10}else if(e.textAlign==='right'){m=t.width/2-10}l.forEach((t,o)=>{e.fillText(t,m,p+o*h)});e.restore()}
        function drawBoxItem(e,t){e.save();const o=t.x+t.width/2,a=t.y+t.height/2;e.translate(o,a);e.rotate(t.rotation);e.scale(t.scaleX||1,t.scaleY||1);if(!t.style||t.style==='fill'){e.fillStyle=t.color;e.fillRect(-t.width/2,-t.height/2,t.width,t.height)}else{e.strokeStyle=t.color;e.lineWidth=4/cameraZoom;e.strokeRect(-t.width/2,-t.height/2,t.width,t.height)}e.restore()}
        function drawCircleItem(e, t) { e.save(); const o = t.x + t.width / 2, a = t.y + t.height / 2, i = t.width / 2, r = t.height / 2; e.translate(o, a); e.rotate(t.rotation); e.scale(t.scaleX || 1, t.scaleY || 1); e.beginPath(); e.ellipse(0, 0, i, r, 0, 0, Math.PI * 2); if (!t.style || t.style === "fill") { e.fillStyle = t.color; e.fill(); } else { e.strokeStyle = t.color; e.lineWidth = 4 / cameraZoom; e.stroke(); } e.restore(); }
        
        function drawMeasureItem(ctx,item){
            const PIXELS_PER_INCH=96, PIXELS_PER_CM=PIXELS_PER_INCH/2.54;
            ctx.save();
            ctx.strokeStyle = item.color || accentColor;
            ctx.fillStyle = item.color || accentColor;
            ctx.lineWidth = 1.5 / cameraZoom; // Slightly thinner main line
            ctx.lineCap = 'round';

            const x1 = item.startX;
            const y1 = item.startY;
            const x2 = item.endX;
            const y2 = item.endY;

            const dx = x2 - x1;
            const dy = y2 - y1;
            const angle = Math.atan2(dy, dx);
            const lengthPx = Math.hypot(dx, dy);
            const tickLength = 10 / cameraZoom; // Length of the diagonal ticks

            // Draw Main Line
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();

            // Draw Start Tick (angled)
            ctx.save();
            ctx.translate(x1, y1);
            ctx.rotate(angle); // Align with the main line
            ctx.rotate(-Math.PI * 3 / 4); // Rotate -135 degrees for the tick angle
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(tickLength, 0);
            ctx.lineWidth = 2 / cameraZoom; // Make ticks slightly bolder
            ctx.stroke();
            ctx.restore();

            // Draw End Tick (angled)
            ctx.save();
            ctx.translate(x2, y2);
            ctx.rotate(angle); // Align with the main line
            ctx.rotate(Math.PI * 3 / 4); // Rotate +135 degrees for the tick angle
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(tickLength, 0);
             ctx.lineWidth = 2 / cameraZoom; // Make ticks slightly bolder
            ctx.stroke();
            ctx.restore();


            // --- Text Calculation and Drawing ---
            let dist, unitLabel = item.unit || 'px';
            switch(unitLabel) {
                case 'cm': dist = lengthPx / PIXELS_PER_CM; break;
                case 'in': dist = lengthPx / PIXELS_PER_INCH; break;
                default: dist = lengthPx;
            }
            const text = `${dist.toFixed(1)} ${unitLabel}`;
            const midX = (x1 + x2) / 2;
            const midY = (y1 + y2) / 2;

            ctx.font = `${14 / cameraZoom}px Inter, sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom'; // Place text slightly above the line

            ctx.save();
            ctx.translate(midX, midY);
            let textAngle = angle;
            // Adjust angle so text is always readable (mostly horizontal)
            if (textAngle < -Math.PI / 2 || textAngle > Math.PI / 2) {
                textAngle += Math.PI;
            }
            ctx.rotate(textAngle);
            // Add a small background rectangle for readability
            const textWidth = ctx.measureText(text).width;
            const textHeight = 16 / cameraZoom; // Approximate height
            ctx.fillStyle = canvasBackgroundColor; // Use background color
            ctx.globalAlpha = 0.7; // Semi-transparent
            ctx.fillRect(-textWidth / 2 - 4/cameraZoom, -textHeight - 4/cameraZoom, textWidth + 8/cameraZoom, textHeight + 4/cameraZoom);
            ctx.globalAlpha = 1.0; // Reset alpha
            ctx.fillStyle = item.color || accentColor; // Text color
            ctx.fillText(text, 0, -5 / cameraZoom); // Offset text slightly above the line
            ctx.restore();
            // --- End Text Drawing ---

            ctx.restore(); // Restore initial context state
        }

        function drawGridItem(e,t){e.save();const o=t.x+t.width/2,a=t.y+t.height/2;e.translate(o,a);e.rotate(t.rotation);e.scale(t.scaleX||1,t.scaleY||1);e.strokeStyle=t.color;e.lineWidth=2/cameraZoom;const i=t.width/t.cols,r=t.height/t.rows;e.beginPath();for(let o=0;o<=t.cols;o++){const a=-t.width/2+o*i;e.moveTo(a,-t.height/2);e.lineTo(a,t.height/2)}for(let o=0;o<=t.rows;o++){const a=-t.height/2+o*r;e.moveTo(-t.width/2,a);e.lineTo(t.width/2,a)}e.stroke();e.restore()}
        function drawStrokeItem(e,t){if(t.points.length<2)return;e.save();e.strokeStyle=t.color;e.lineWidth=4/cameraZoom;e.lineCap='round';e.lineJoin='round';e.beginPath();e.moveTo(t.points[0].x,t.points[0].y);for(let o=1;o<t.points.length;o++){e.lineTo(t.points[o].x,t.points[o].y)}e.stroke();e.restore()}
        function drawGroupItem(e,t){e.save();e.globalAlpha*=(t.opacity??1);const o=t.x+t.width/2,a=t.y+t.height/2;e.translate(o,a);e.rotate(t.rotation||0);e.scale(t.scaleX||1,t.scaleY||1);t.items.forEach(o=>{const a={...o,x:o.x-t.width/2,y:o.y-t.height/2};if(a.type==="arrow"||a.type==='measure'){a.startX=o.startX-t.width/2;a.startY=o.startY-t.height/2;a.endX=o.endX-t.width/2;a.endY=o.endY-t.height/2}if(a.type==="stroke"){a.points=o.points.map(e=>({x:e.x-t.width/2,y:e.y-t.height/2}))}if(o.type==="image"){e.save();const t=a.x+a.width/2,i=a.y+a.height/2;e.translate(t,i);e.rotate(a.rotation||0);e.scale(a.scaleX||1,a.scaleY||1);if(o.img&&o.img.complete)e.drawImage(o.img,-a.width/2,-a.height/2,a.width,a.height);e.restore()}else if(o.type==="arrow")drawArrow(e,a);else if(o.type==="text")drawTextItem(e,a);else if(o.type==="box")drawBoxItem(e,a);else if(o.type==='circle')drawCircleItem(e,a);else if(o.type==='measure')drawMeasureItem(e,a);else if(o.type==="stroke")drawStrokeItem(e,a);else if(o.type==="grid")drawGridItem(e,a)});e.restore()}
        
        function handleKeyDown(e) {
            const activeEl = document.activeElement;
            if (currentlyEditingText || (activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA'))) { return; }
            const key = e.key.toLowerCase();
            if (key === 'escape') { e.preventDefault(); if (helpModalOverlay.style.display === 'flex') { helpModalOverlay.style.display = 'none'; return; } if (currentTool) { setCurrentTool(null); } else if (selectedItems.length > 0) { selectedItems = []; updateSelectionToolbar(); updateLeftBarState(); } return; }
            if (e.shiftKey && key === 'n') { e.preventDefault(); confirmNewBoard(); return; }
            if (e.shiftKey && key === 'c') { e.preventDefault(); copyToClipboard(); return; }
            if (e.altKey && key === 'g') { e.preventDefault(); setCurrentTool('grid'); return; }
            if (e.ctrlKey) {
                if (e.shiftKey && key === 'a') { e.preventDefault(); autoAlignSelection(); return; }
                if (e.shiftKey && key === 'z') { e.preventDefault(); redoLastAction(); return; }
                if (e.shiftKey && key === 'g') { e.preventDefault(); ungroupSelectedItems(); return; }
                if (key === 's') { e.preventDefault(); saveProject(); return; }
                if (key === 'o') { e.preventDefault(); projectInput.click(); return; }
                if (key === 'z') { e.preventDefault(); undoLastAction(); return; }
                if (key === 'a' && !e.shiftKey) { e.preventDefault(); selectedItems = [...items]; updateSelectionToolbar(); updateLeftBarState(); return; }
                if (key === 'i') { e.preventDefault(); const selectedIds = new Set(selectedItems.map(item => item.id)); selectedItems = items.filter(item => !selectedIds.has(item.id)); updateSelectionToolbar(); updateLeftBarState(); showToast(`Selection inverted (${selectedItems.length} items selected).`); return; }
                if (key === 'c') { e.preventDefault(); copyItems(); return; }
                if (key === 'x') { e.preventDefault(); cutItems(); return; }
                if (key === 'v') { return; }
                if (key === 'd') { e.preventDefault(); duplicateItems(); return; }
                if (key === 'g') { e.preventDefault(); groupSelectedItems(); return; }
            }
            if (e.shiftKey && key === 's') { e.preventDefault(); saveAsPng(); return; }
            if (e.shiftKey && key.toLowerCase() === 'a') { e.preventDefault(); setCurrentTool('arrow'); return; }
            if (key === 'a' && !e.shiftKey && !e.ctrlKey && !e.altKey) { e.preventDefault(); setCurrentTool(null); return; }
            if (key === 'g' && !e.altKey) { e.preventDefault(); showGrid = !showGrid; showGridToggle.checked = showGrid; return; }
            if (key === 't') { e.preventDefault(); setCurrentTool('text'); return; }
            if (key === 'i') { e.preventDefault(); imageInput.click(); return; }
            if (key === 'b') { e.preventDefault(); setCurrentTool('box'); return; }
            if (key === 'c') { e.preventDefault(); setCurrentTool('circle'); return; }
            if (key === 'm') { e.preventDefault(); setCurrentTool('measure'); return; }
            if (key === 'd') { e.preventDefault(); setCurrentTool('draw'); return; }
            if (key === 'e') { e.preventDefault(); setCurrentTool('eyedropper'); return; }
            if (selectedItems.length === 0) return;
            if (key === 'h') { e.preventDefault(); flipHorizontal(); return; }
            if (key === 'v') { e.preventDefault(); flipVertical(); return; }
            if (key === 'home') { e.preventDefault(); bringSelectedToFront(); return; }
            if (key === 'end') { e.preventDefault(); sendSelectedToBack(); return; }
            if (key === 'pageup') { e.preventDefault(); moveSelectedUp(); return; }
            if (key === 'pagedown') { e.preventDefault(); moveSelectedDown(); return; }
            if (key === 'delete' || key === 'backspace') { e.preventDefault(); deleteSelectedItems(); return; }
            if (selectedItems.length !== 1) return;
            const item = selectedItems[0];
            e.preventDefault();
            if (key === 'p') { togglePin(); return; }
            if (item.isPinned) return;
            switch (key) { case 'r': setActiveGizmo('rotate'); break; case 's': setActiveGizmo('scale'); break; }
        }

        function onDoubleClick(e){const t=screenToWorld(getEventLocation(e)),o=getItemAtPosition(t);if(o&&o.type==='text'&&!o.isPinned)editText(o)}
        function onMouseDown(e){if(currentlyEditingText){finishEditingText();return}const t=getEventLocation(e),o=screenToWorld(t);if(currentTool==='eyedropper'){const pixelData=ctx.getImageData(t.x,t.y,1,1).data,hexColor=rgbToHex(pixelData[0],pixelData[1],pixelData[2]);accentColor=hexColor;updateUIColors();saveSettings();setCurrentTool(null);return}if(e.button===0){if(selectedItems.length===1){if((selectedItems[0].type==='arrow'||selectedItems[0].type==='measure')&&!selectedItems[0].isPinned){const e=getArrowHandleAtPosition(o);if(e){isTransformingArrow=!0;transformingHandle=e;return}}const e=getGizmoAtPosition(o);if(e&&!selectedItems[0].isPinned){isTransforming=!0;const t=selectedItems[0];originalItemState=JSON.parse(JSON.stringify(t));reattachImages(t,originalItemState);originalItemState.centerX=t.x+t.width/2;originalItemState.centerY=t.y+t.height/2;originalItemState.startAngle=Math.atan2(o.y-originalItemState.centerY,o.x-originalItemState.centerX);originalItemState.startDist=Math.hypot(o.x-originalItemState.centerY,o.y-originalItemState.centerX);if(e==='scale'){const e={x:-originalItemState.width/2,y:-originalItemState.height/2},t=Math.cos(originalItemState.rotation),o=Math.sin(originalItemState.rotation),a=e.x*t-e.y*o+originalItemState.centerX,i=e.x*o+e.y*t+originalItemState.centerY;originalItemState.pivot={x:a,y:i}}return}}if(currentTool){isDrawing=!0;let e;if(currentTool==='arrow'){e={id:Date.now(),type:'arrow',startX:o.x,startY:o.y,endX:o.x,endY:o.y,rotation:0,isPinned:!1,x:o.x,y:o.y,width:0,height:0,opacity:1,scaleX:1,scaleY:1}}else if(currentTool==='text'){e={id:Date.now(),type:'text',text:'Type...',x:o.x,y:o.y,width:0,height:0,fontSize:32,rotation:0,isPinned:!1,opacity:1,fontFamily:'Inter',textAlign:'center',fontWeight:'bold',fontStyle:'normal',color:accentColor,scaleX:1,scaleY:1}}else if(currentTool==='box'){e={id:Date.now(),type:'box',color:accentColor,x:o.x,y:o.y,width:0,height:0,rotation:0,isPinned:!1,style:'fill',opacity:1,scaleX:1,scaleY:1}}else if(currentTool==='circle'){e={id:Date.now(),type:'circle',color:accentColor,x:o.x,y:o.y,width:0,height:0,rotation:0,isPinned:!1,style:'fill',opacity:1,scaleX:1,scaleY:1}}else if(currentTool==='measure'){e={id:Date.now(),type:'measure',startX:o.x,startY:o.y,endX:o.x,endY:o.y,unit:'px',color:accentColor,isPinned:!1,x:o.x,y:o.y,width:0,height:0,rotation:0,opacity:1}}else if(currentTool==='grid'){e={id:Date.now(),type:'grid',color:accentColor,x:o.x,y:o.y,width:0,height:0,rotation:0,isPinned:!1,opacity:1,rows:3,cols:3,scaleX:1,scaleY:1}}else if(currentTool==='draw'){e={id:Date.now(),type:'stroke',points:[{x:o.x,y:o.y}],color:accentColor,isPinned:!1,x:o.x,y:o.y,width:0,height:0,opacity:1,scaleX:1,scaleY:1}}items.push(e);selectedItems=[e];bringSelectedToFront()}else{const t=getItemAtPosition(o);if(e.shiftKey){if(t){const e=selectedItems.findIndex(e=>e.id===t.id);if(e>-1)selectedItems.splice(e,1);else selectedItems.push(t)}}else{if(t){if(!selectedItems.includes(t)){selectedItems=[t]}isMovingItems=!0;moveStart.x=o.x;moveStart.y=o.y;selectedItems.forEach(e=>{e.originalX=e.x;e.originalY=e.y;if(e.type==='arrow'||e.type==='measure'){e.originalStartX=e.startX;e.originalStartY=e.startY;e.originalEndX=e.endX;e.originalEndY=e.endY}else if(e.type==='stroke'){e.originalPoints=JSON.parse(JSON.stringify(e.points))}else if(e.type==='group'){e.originalItems=JSON.parse(JSON.stringify(e.items));reattachImages(e,{items:e.originalItems})}})}else{selectedItems=[];isSelectingBox=!0;selectionBox.startX=o.x;selectionBox.startY=o.y;selectionBox.endX=o.x;selectionBox.endY=o.y}}updateSelectionToolbar();updateLeftBarState()}}else if(e.button===1){isDragging=!0;dragStart.x=getEventLocation(e).x/cameraZoom-cameraOffset.x;dragStart.y=getEventLocation(e).y/cameraZoom-cameraOffset.y;canvas.classList.add('grabbing')}}
        function onMouseUp(e){if(e.button===0){if(isDrawing||isMovingItems||isTransforming||isTransformingArrow){if(isDrawing){const e=selectedItems[0];if(e&&(e.type==='text'||e.type==='box'||e.type==='circle'||e.type==='grid')&&(e.width<10||e.height<10)){items=items.filter(t=>t.id!==e.id);selectedItems=[]}else if(e&&e.type==='text'){editText(e)}}saveStateForUndo()}if(isSelectingBox){isSelectingBox=!1;const e=getNormalizedSelectionBox();selectedItems=items.filter(t=>rectsIntersect(getItemBoundingBox(t),e));updateSelectionToolbar();updateLeftBarState()}isDrawing=!1;isMovingItems=!1;isTransforming=!1;isTransformingArrow=!1;transformingHandle=null;originalItemState=null}else if(e.button===1){isDragging=!1;canvas.classList.remove('grabbing')}}
        function onMouseMove(e){
            const worldPos = screenToWorld(getEventLocation(e));
            if (isSelectingBox) {
                selectionBox.endX = worldPos.x;
                selectionBox.endY = worldPos.y;
                return;
            }
            if (isTransformingArrow && selectedItems.length === 1) {
                const item = selectedItems[0];
                if (transformingHandle === 'start') {
                    item.startX = worldPos.x;
                    item.startY = worldPos.y;
                } else if (transformingHandle === 'end') {
                    item.endX = worldPos.x;
                    item.endY = worldPos.y;
                }
                 // Recalculate bounding box for arrow/measure after moving handle
                 if (item.type === 'arrow' || item.type === 'measure') {
                    const bbox = getItemBoundingBox(item);
                    item.x = bbox.x;
                    item.y = bbox.y;
                    item.width = bbox.width;
                    item.height = bbox.height;
                 }
                return;
            }
            if (isTransforming && selectedItems.length === 1) {
                const item = selectedItems[0];
                const centerX = originalItemState.centerX;
                const centerY = originalItemState.centerY;

                if (activeGizmo === 'rotate') {
                    const currentAngle = Math.atan2(worldPos.y - centerY, worldPos.x - centerX);
                    let newRotation = originalItemState.rotation + (currentAngle - originalItemState.startAngle);
                    if (e.shiftKey) { // Snap rotation to 15-degree increments
                        newRotation = Math.round(newRotation / (Math.PI / 12)) * (Math.PI / 12);
                    }
                    item.rotation = newRotation;
                } else if (activeGizmo === 'scale') {
                    let scaleRatio = 1;
                    if (e.shiftKey) { // Maintain aspect ratio scaling
                         const pivot = originalItemState.pivot;
                         const cosR = Math.cos(originalItemState.rotation);
                         const sinR = Math.sin(originalItemState.rotation);
                         const handleRotatedX = (originalItemState.centerX + originalItemState.width / 2 * cosR - originalItemState.height / 2 * sinR);
                         const handleRotatedY = (originalItemState.centerY + originalItemState.width / 2 * sinR + originalItemState.height / 2 * cosR);
                         const origDiagVec = { x: handleRotatedX - pivot.x, y: handleRotatedY - pivot.y };
                         const currentMouseVec = { x: worldPos.x - pivot.x, y: worldPos.y - pivot.y };
                         const origDiagMagSq = origDiagVec.x * origDiagVec.x + origDiagVec.y * origDiagVec.y;
                         const dotProduct = currentMouseVec.x * origDiagVec.x + currentMouseVec.y * origDiagVec.y;
                         let ratio = 1;
                         if (origDiagMagSq > 1e-4) { // Avoid division by zero
                            ratio = dotProduct / origDiagMagSq;
                         }
                         scaleRatio = Math.max(0.05, ratio); // Prevent zero or negative scale

                         const newWidth = originalItemState.width * scaleRatio;
                         const newHeight = originalItemState.height * scaleRatio;
                         // Adjust position based on pivot
                         const newCenterX = pivot.x + origDiagVec.x * scaleRatio / 2;
                         const newCenterY = pivot.y + origDiagVec.y * scaleRatio / 2;

                         item.width = newWidth;
                         item.height = newHeight;
                         item.x = newCenterX - newWidth / 2;
                         item.y = newCenterY - newHeight / 2;

                    } else { // Free scaling
                        const dist = Math.hypot(worldPos.x - centerX, worldPos.y - centerY);
                        scaleRatio = Math.max(0.1, dist / originalItemState.startDist); // Prevent tiny/negative scale
                        item.width = originalItemState.width * scaleRatio;
                        item.height = originalItemState.height * scaleRatio;
                        item.x = centerX - item.width / 2;
                        item.y = centerY - item.height / 2;
                    }

                    // Scale internal elements if it's a group
                    if (item.type === 'group') {
                        const origW = originalItemState.width;
                        const origH = originalItemState.height;
                        const scaleX = item.width / origW;
                        const scaleY = item.height / origH;
                        if (isFinite(scaleX) && isFinite(scaleY)) { // Ensure scale factors are valid numbers
                            item.items.forEach((subItem, idx) => {
                                const origItem = originalItemState.items[idx];
                                // Scale position relative to group top-left
                                subItem.x = origItem.x * scaleX;
                                subItem.y = origItem.y * scaleY;
                                subItem.width = origItem.width * scaleX;
                                subItem.height = origItem.height * scaleY;
                                // Scale specific properties
                                if (subItem.type === 'text') {
                                    subItem.fontSize = origItem.fontSize * Math.min(scaleX, scaleY); // Scale font size
                                } else if (subItem.type === 'arrow' || subItem.type === 'measure') {
                                    subItem.startX = origItem.startX * scaleX;
                                    subItem.startY = origItem.startY * scaleY;
                                    subItem.endX = origItem.endX * scaleX;
                                    subItem.endY = origItem.endY * scaleY;
                                } else if (subItem.type === 'stroke') {
                                    subItem.points = origItem.points.map(p => ({ x: p.x * scaleX, y: p.y * scaleY }));
                                }
                            });
                         }
                    } else if (item.type === 'text') { // Scale font size for text items
                        item.fontSize = originalItemState.fontSize * scaleRatio;
                    }
                }
            } else if (isMovingItems && selectedItems.length > 0) {
                const deltaX = worldPos.x - moveStart.x;
                const deltaY = worldPos.y - moveStart.y;
                const doSnap = e.shiftKey ? !snapToGrid : snapToGrid; // Toggle snap with Shift

                selectedItems.forEach(item => {
                    if (item.isPinned) return;
                    let currentDeltaX = deltaX;
                    let currentDeltaY = deltaY;

                    if (doSnap && selectedItems.length === 1) { // Only snap single items for simplicity
                        const snappedX = Math.round((item.originalX + deltaX) / gridSize) * gridSize;
                        const snappedY = Math.round((item.originalY + deltaY) / gridSize) * gridSize;
                        currentDeltaX = snappedX - item.originalX;
                        currentDeltaY = snappedY - item.originalY;
                    }

                    item.x = item.originalX + currentDeltaX;
                    item.y = item.originalY + currentDeltaY;

                    if (item.type === 'arrow' || item.type === 'measure') {
                        item.startX = item.originalStartX + currentDeltaX;
                        item.startY = item.originalStartY + currentDeltaY;
                        item.endX = item.originalEndX + currentDeltaX;
                        item.endY = item.originalEndY + currentDeltaY;
                    } else if (item.type === 'stroke') {
                        item.points = item.originalPoints.map(p => ({ x: p.x + currentDeltaX, y: p.y + currentDeltaY }));
                    }
                });
            } else if (isDrawing && selectedItems.length === 1) {
                const item = selectedItems[0];
                if (item.type === 'arrow' || item.type === 'measure') {
                    if (e.shiftKey) { // Snap angle
                        const dx = worldPos.x - item.startX;
                        const dy = worldPos.y - item.startY;
                        const angle = Math.atan2(dy, dx);
                        const dist = Math.hypot(dx, dy);
                        const snappedAngle = Math.round(angle / (Math.PI / 4)) * (Math.PI / 4); // Snap to 45 degrees
                        item.endX = item.startX + dist * Math.cos(snappedAngle);
                        item.endY = item.startY + dist * Math.sin(snappedAngle);
                    } else {
                        item.endX = worldPos.x;
                        item.endY = worldPos.y;
                    }
                     // Update bounding box as it's drawn
                     const bbox = getItemBoundingBox(item);
                     item.x = bbox.x;
                     item.y = bbox.y;
                     item.width = bbox.width;
                     item.height = bbox.height;
                } else if (item.type === 'text' || item.type === 'box' || item.type === 'circle' || item.type === 'grid') {
                    const startX = item.x;
                    const startY = item.y;
                    const currentX = worldPos.x;
                    const currentY = worldPos.y;

                    let finalX = Math.min(startX, currentX);
                    let finalY = Math.min(startY, currentY);
                    let finalWidth = Math.abs(startX - currentX);
                    let finalHeight = Math.abs(startY - currentY);

                    if (e.shiftKey) { // Draw square/circle
                        const size = Math.max(finalWidth, finalHeight);
                        finalWidth = size;
                        finalHeight = size;
                        if (currentX < startX) { finalX = startX - size; }
                        if (currentY < startY) { finalY = startY - size; }
                    }

                    item.x = finalX;
                    item.y = finalY;
                    item.width = finalWidth;
                    item.height = finalHeight;

                } else if (item.type === 'stroke') {
                    item.points.push({ x: worldPos.x, y: worldPos.y });
                    // Update bounding box for stroke as it's drawn
                    const bbox = getItemBoundingBox(item);
                    item.x = bbox.x;
                    item.y = bbox.y;
                    item.width = bbox.width;
                    item.height = bbox.height;
                }
            } else if (isDragging) {
                cameraOffset.x = getEventLocation(e).x / cameraZoom - dragStart.x;
                cameraOffset.y = getEventLocation(e).y / cameraZoom - dragStart.y;
            }

            // Update cursor based on hover state if not dragging/drawing etc.
             if (!isDragging && !isMovingItems && !isTransforming && !isTransformingArrow) {
                const currentGizmo = getGizmoAtPosition(worldPos);
                const currentArrowHandle = getArrowHandleAtPosition(worldPos);

                if (currentGizmo !== hoveredGizmo || currentArrowHandle !== hoveredArrowHandle) {
                    hoveredGizmo = currentGizmo;
                    hoveredArrowHandle = currentArrowHandle;
                    // Update cursor immediately
                    if (hoveredGizmo || hoveredArrowHandle) {
                        canvas.style.cursor = 'pointer';
                    } else if (getItemAtPosition(worldPos)) {
                         canvas.style.cursor = 'move';
                    } else if (currentTool) {
                         canvas.style.cursor = 'crosshair';
                    } else {
                        canvas.style.cursor = 'grab';
                    }
                }
             }
        }
        function onContextMenu(e){e.preventDefault();const t=getItemAtPosition(screenToWorld(getEventLocation(e)));if(t&&!selectedItems.includes(t)){selectedItems=[t];updateSelectionToolbar();updateLeftBarState()}if(selectedItems.length>0){opacitySliderContainer.style.display='flex';opacitySeparator.style.display='block';const e=selectedItems[0].opacity??1;itemOpacitySlider.value=e;itemOpacityValue.textContent=`${Math.round(e*100)}%`;deleteItemBtn.style.display='flex';document.getElementById('delete-separator').style.display='block'}else{opacitySliderContainer.style.display='none';opacitySeparator.style.display='none';deleteItemBtn.style.display='none';document.getElementById('delete-separator').style.display='none'}const o=selectedItems.length===1&&selectedItems[0].type==='image';downloadImageBtn.style.display=o?'flex':'none';downloadSeparator.style.display=o?'block':'none';showAndPositionMenu(contextMenu,e)}
        function confirmNewBoard(){if(items.length>0){showConfirmationModal()}else{resetBoard()}}
        function resetBoard(){const e=projects.find(e=>e.id===activeProjectId);if(!e)return;e.data.items=[];e.data.cameraOffset={x:window.innerWidth/2,y:(window.innerHeight-48)/2};e.data.cameraZoom=1;e.data.historyStack=[];e.data.historyIndex=-1;e.data.canvasBackgroundColor='#0d0d0d';e.data.accentColor='#429eff';e.data.gridColor='#f9f8f6';switchTab(activeProjectId);saveStateForUndo()}
        function showConfirmationModal(){confirmationModalOverlay.style.display='flex'}
        function hideConfirmationModal(){confirmationModalOverlay.style.display='none'}
        async function copyToClipboard(){if(items.length===0){showToast("Board is empty, nothing to copy.","error");return}let e=Infinity,t=Infinity,o=-Infinity,a=-Infinity;items.forEach(i=>{const r=getItemBoundingBox(i);e=Math.min(e,r.x);t=Math.min(t,r.y);o=Math.max(o,r.x+r.width);a=Math.max(a,r.y+r.height)});const i=50,r=o-e+i*2,s=a-t+i*2,n=document.createElement('canvas');n.width=r;n.height=s;const l=n.getContext('2d');l.fillStyle=canvasBackgroundColor;l.fillRect(0,0,r,s);l.translate(-e+i,-t+i);items.forEach(e=>{l.save();l.globalAlpha=e.opacity??1;if(showDropShadow){l.shadowColor='rgba(0,0,0,0.4)';l.shadowBlur=15;l.shadowOffsetX=4;l.shadowOffsetY=4}if(e.type==='image'){const t=e.x+e.width/2,o=e.y+e.height/2;l.translate(t,o);l.rotate(e.rotation);l.scale(e.scaleX||1,e.scaleY||1);l.drawImage(e.img,-e.width/2,-e.height/2,e.width,e.height)}else if(e.type==='arrow'){drawArrow(l,e)}else if(e.type==='text'){drawTextItem(l,e)}else if(e.type==='box'){drawBoxItem(l,e)}else if(e.type==='circle'){drawCircleItem(l,e)}else if(e.type==='measure'){drawMeasureItem(l,e)}else if(e.type==='stroke'){drawStrokeItem(l,e)}else if(e.type==='grid'){drawGridItem(l,e)}else if(e.type==='group'){drawGroupItem(l,e)}l.restore()});try{const e=await new Promise(e=>n.toBlob(e,'image/png')),t=new ClipboardItem({'image/png':e});await navigator.clipboard.write([t]);showToast("Board copied to clipboard.")}catch(e){console.error('Failed to copy image to clipboard:',e);showToast('Failed to copy to clipboard.','error')}}
        function saveAsPng(){if(items.length===0){showToast("Board is empty, nothing to export.","error");return}let e=Infinity,t=Infinity,o=-Infinity,a=-Infinity;items.forEach(i=>{const r=getItemBoundingBox(i);e=Math.min(e,r.x);t=Math.min(t,r.y);o=Math.max(o,r.x+r.width);a=Math.max(a,r.y+r.height)});const i=o-e+100,r=a-t+100,s=document.createElement('canvas');s.width=i;s.height=r;const n=s.getContext('2d');n.fillStyle=canvasBackgroundColor;n.fillRect(0,0,i,r);n.translate(-e+50,-t+50);items.forEach(e=>{n.save();n.globalAlpha=e.opacity??1;if(showDropShadow){n.shadowColor='rgba(0,0,0,0.4)';n.shadowBlur=15;n.shadowOffsetX=4;n.shadowOffsetY=4}if(e.type==='image'){const t=e.x+e.width/2,o=e.y+e.height/2;n.translate(t,o);n.rotate(e.rotation);n.scale(e.scaleX||1,e.scaleY||1);n.drawImage(e.img,-e.width/2,-e.height/2,e.width,e.height)}else if(e.type==='arrow'){drawArrow(n,e)}else if(e.type==='text'){drawTextItem(n,e)}else if(e.type==='box'){drawBoxItem(n,e)}else if(e.type==='circle'){drawCircleItem(n,e)}else if(e.type==='measure'){drawMeasureItem(n,e)}else if(e.type==='stroke'){drawStrokeItem(n,e)}else if(e.type==='grid'){drawGridItem(n,e)}else if(e.type==='group'){drawGroupItem(n,e)}n.restore()});const l=document.createElement('a');l.download='moodboard.png';l.href=s.toDataURL('image/png');l.click();showToast("Image exported as PNG.")}
        function saveProject(){const t=projects.find(e=>e.id===activeProjectId);if(!t){showToast("No active project to save.","error");return}let e;const o=`${t.name}.json`;if(t.type==='moodinfinite'){const o=projects.find(e=>e.id===activeProjectId);if(o){o.data.items=items;o.data.cameraOffset=cameraOffset;o.data.cameraZoom=cameraZoom;o.data.historyStack=historyStack;o.data.historyIndex=historyIndex}e={items:items.map(t=>{const e={...t};if(t.type==='image'&&t.img){e.img=t.img.src}else if(t.type==='group'&&t.items){e.items=t.items.map(e=>{const o={...e};if(e.type==='image'&&e.img){o.img=e.img.src}return o})}return e}),cameraOffset:cameraOffset,cameraZoom:cameraZoom,canvasBackgroundColor:canvasBackgroundColor,accentColor:accentColor,gridColor:gridColor,showGrid:showGrid,snapToGrid:snapToGrid,showDropShadow:showDropShadow,gridSize:gridSize,gridOpacity:gridOpacity}}else if(t.type==='moodprompt'){e=t.data}else{showToast("Unknown project type, cannot save.","error");return}const a=new Blob([JSON.stringify(e,null,2)],{type:'application/json'}),n=document.createElement('a');n.href=URL.createObjectURL(a);n.download=o;document.body.appendChild(n);n.click();document.body.removeChild(n);URL.revokeObjectURL(n.href);showToast("Project saved successfully.")}
        function loadFileAsNewTab(fileContent,fileName){try{const data=JSON.parse(fileContent);const name=fileName.split('.').slice(0,-1).join('.')||'Loaded Project';if(data.prompts&&Array.isArray(data.prompts)){const newId=Date.now();const newProject={id:newId,type:'moodprompt',name:name,data:{prompts:data.prompts,canvasBackgroundColor:data.canvasBackgroundColor||'#0d0d0d'}};projects.push(newProject);renderTabs();switchTab(newId);showToast("Prompt file loaded successfully.");return}if(data.items&&Array.isArray(data.items)){const newId=Date.now();const newProject={id:newId,type:'moodinfinite',name:name,data:{items:[],cameraOffset:{},cameraZoom:1,historyStack:[],historyIndex:-1}};projects.push(newProject);activeProjectId=newId;renderTabs();loadProject(fileContent);return}showToast("Failed to load project. Unknown format.","error")}catch(err){console.error("Failed to load project:",err);showToast("Failed to load project. Invalid JSON.","error")}}
        function loadProject(e){try{const t=JSON.parse(e);const o=projects.find(e=>e.id===activeProjectId);if(!o||o.type!=='moodinfinite')return;o.data.cameraOffset=t.cameraOffset||{x:window.innerWidth/2,y:window.innerHeight/2};o.data.cameraZoom=t.cameraZoom||1;canvasBackgroundColor=t.canvasBackgroundColor||'#0d0d0d';accentColor=t.accentColor||'#429eff';gridColor=t.gridColor||'#f9f8f6';o.data.canvasBackgroundColor=canvasBackgroundColor;o.data.accentColor=accentColor;o.data.gridColor=gridColor;showGrid=t.showGrid??true;snapToGrid=t.snapToGrid??true;showDropShadow=t.showDropShadow??true;gridSize=t.gridSize||50;gridOpacity=t.gridOpacity||.05;const a=e=>{return e.map(e=>{const t={...(e.scaleX!==void 0?{}:{scaleX:1,scaleY:1}),...e};if(t.type==='image'){const o=new Image;o.src=e.img;t.img=o}else if(t.type==='group'){t.items=a(e.items)}return t})};o.data.items=a(t.items);o.data.historyStack=[];o.data.historyIndex=-1;switchTab(activeProjectId);updateUIColors();saveStateForUndo();showToast("Project loaded successfully.")}catch(e){console.error("Failed to load project:",e);showToast("Failed to load project. Invalid file.","error")}}
        function handleImageUpload(e){if(!e.target.files)return;const t=screenToWorld({x:canvas.width/2,y:canvas.height/2});processFiles(e.target.files,t);imageInput.value=''}
        function handleProjectUpload(e){const t=e.target.files[0];if(!t)return;const o=new FileReader;o.onload=e=>{loadFileAsNewTab(e.target.result,t.name)};o.readAsText(t);projectInput.value=''}

        function handlePaste(e) {
            const files = Array.from(e.clipboardData.items)
                .filter(item => item.type.startsWith('image/'))
                .map(item => item.getAsFile());
            const isInternalClipboardOld = (Date.now() - internalClipboardTimestamp) > 500;
            if (files.length > 0 && isInternalClipboardOld) {
                processFiles(files, screenToWorld({ x: canvas.width / 2, y: canvas.height / 2 }));
                return;
            }
            if (clipboard.length > 0) {
                pasteItems();
            }
        }
        
        function handleDragOver(e){e.preventDefault();canvas.style.outline=`2px dashed ${accentColor}`;canvas.style.outlineOffset='-10px'}
        function handleDragLeave(e){e.preventDefault();canvas.style.outline='none'}
        function handleDrop(e){e.preventDefault();handleDragLeave(e);if(!e.dataTransfer.files)return;const t=e.dataTransfer.files[0];if(t&&(t.name.endsWith('.json')||t.name.endsWith('.mood'))){const o=new FileReader;o.onload=e=>{loadFileAsNewTab(e.target.result,t.name)};o.readAsText(t)}else{processFiles(e.dataTransfer.files,screenToWorld(getEventLocation(e)))}}
        function processFiles(e,t){Array.from(e).forEach((e,o)=>{if(!e.type.startsWith('image/'))return;const a=new FileReader;a.onload=e=>{const a=new Image;a.onload=()=>{const e=a.width/a.height,i=250,r=i/e;items.push({id:Date.now()+o,type:'image',img:a,x:t.x-i/2+o*20,y:t.y-r/2+o*20,width:i,height:r,rotation:0,isPinned:!1,opacity:1,scaleX:1,scaleY:1});bringSelectedToFront()};a.src=e.target.result};a.readAsDataURL(e)});setTimeout(saveStateForUndo,500)}
        function downloadSourceImage(){if(selectedItems.length!==1||selectedItems[0].type!=='image')return;const e=selectedItems[0],t=document.createElement('a');t.href=e.img.src;try{const e=new URL(t.href),o=e.pathname.split('/');t.download=o[o.length-1]||'source_image'}catch(e){t.download='source_image.png'}document.body.appendChild(t);t.click();document.body.removeChild(t);showToast("Source image download started.")}
        
        function copyItems(e=!0){
            if(selectedItems.length===0)return;
            clipboard=selectedItems.map(e=>{
                const t=JSON.parse(JSON.stringify(e));
                if(e.type==='image'){t.imgSrc=e.img.src;delete t.img}
                else if(e.type==='group'){e.items.forEach((e,o)=>{if(e.type==='image'){t.items[o].imgSrc=e.img.src;delete t.items[o].img}})}
                return t
            });
            internalClipboardTimestamp = Date.now();
            if(e){showToast(`${selectedItems.length} item${selectedItems.length>1?'s':''} copied.`)}
        }
        
        function cutItems(){
            if(selectedItems.length===0)return;
            copyItems(!1);
            const e=clipboard.length;
            deleteSelectedItems();
            showToast(`${e} item${e>1?'s':''} cut to clipboard.`)
        }

        function pasteItems(){if(clipboard.length===0){showToast("Clipboard is empty.","error");return}const e=[],t=20/cameraZoom,o=a=>{const i=JSON.parse(JSON.stringify(a));i.id=Date.now()+Math.random();i.isPinned=!1;function r(e){if(e.type==='image'){const t=new Image;t.src=e.imgSrc;delete e.imgSrc;e.img=t}else if(e.type==='group'){e.items.forEach(r)}}r(i);i.x+=t;i.y+=t;if(i.type==='arrow'||i.type==='measure'){i.startX+=t;i.startY+=t;i.endX+=t;i.endY+=t}else if(i.type==='stroke'){i.points.forEach(e=>{e.x+=t;e.y+=t})}return i};clipboard.forEach(t=>{const a=o(t);items.push(a);e.push(a)});selectedItems=e;updateSelectionToolbar();updateLeftBarState();saveStateForUndo();showToast(`${e.length} item${e.length>1?'s':''} pasted.`)}
        function duplicateItems(){if(selectedItems.length===0)return;const e=selectedItems,t=[],o=20/cameraZoom;e.forEach(e=>{const a=JSON.parse(JSON.stringify(e));reattachImages(e,a);a.id=Date.now()+Math.random();a.isPinned=!1;a.x+=o;a.y+=o;if(a.type==='arrow'||a.type==='measure'){a.startX+=o;a.startY+=o;a.endX+=o;a.endY+=o}else if(a.type==='stroke'){a.points.forEach(e=>{e.x+=o;e.y+=o})}items.push(a);t.push(a)});selectedItems=t;updateSelectionToolbar();updateLeftBarState();saveStateForUndo();showToast(`${t.length} item${t.length>1?'s':''} duplicated.`)}
        function deleteSelectedItems(){if(selectedItems.length>0){const e=new Set(selectedItems.map(e=>e.id));items=items.filter(t=>!e.has(t.id));selectedItems=[];updateSelectionToolbar();updateLeftBarState();saveStateForUndo()}}
        function bringSelectedToFront(){if(selectedItems.length===0)return;const e=new Set(selectedItems.map(e=>e.id)),t=items.filter(t=>e.has(t.id)),o=items.filter(t=>!e.has(t.id));items=[...o,...t];saveStateForUndo()}
        function sendSelectedToBack(){if(selectedItems.length===0)return;const e=new Set(selectedItems.map(e=>e.id)),t=items.filter(t=>e.has(t.id)),o=items.filter(t=>!e.has(t.id));items=[...t,...o];saveStateForUndo()}
        function moveSelectedUp(){if(selectedItems.length!==1)return;const e=selectedItems[0],t=items.findIndex(t=>t.id===e.id);if(t>-1&&t<items.length-1){[items[t],items[t+1]]=[items[t+1],items[t]];saveStateForUndo()}}
        function moveSelectedDown(){if(selectedItems.length!==1)return;const e=selectedItems[0],t=items.findIndex(t=>t.id===e.id);if(t>0){[items[t],items[t-1]]=[items[t-1],items[t]];saveStateForUndo()}}
        function toggleBoxStyle(){let e=!1;selectedItems.forEach(t=>{if(t.type==='box'||t.type==='circle'){t.style=t.style==='fill'?'outline':'fill';e=!0}});if(e){saveStateForUndo()}}
        function flipHorizontal(){if(selectedItems.length===0)return;selectedItems.forEach(item=>{if(item.type==='arrow'||item.type==='stroke'||item.type==='measure'){const bbox=getItemBoundingBox(item);const centerX=bbox.x+bbox.width/2;if(item.type==='arrow'||item.type==='measure'){item.startX=centerX-(item.startX-centerX);item.endX=centerX-(item.endX-centerX)}else{item.points.forEach(p=>{p.x=centerX-(p.x-centerX)})}}else{item.scaleX=(item.scaleX||1)*-1}});saveStateForUndo()}
        function flipVertical(){if(selectedItems.length===0)return;selectedItems.forEach(item=>{if(item.type==='arrow'||item.type==='stroke'||item.type==='measure'){const bbox=getItemBoundingBox(item);const centerY=bbox.y+bbox.height/2;if(item.type==='arrow'||item.type==='measure'){item.startY=centerY-(item.startY-centerY);item.endY=centerY-(item.endY-centerY)}else{item.points.forEach(p=>{p.y=centerY-(p.y-centerY)})}}else{item.scaleY=(item.scaleY||1)*-1}});saveStateForUndo()}
        function autoAlignSelection(){if(selectedItems.length<2)return;let e=0,t=0;selectedItems.forEach(o=>{e+=getItemBoundingBox(o).width;t+=getItemBoundingBox(o).height});const o=e/selectedItems.length,a=t/selectedItems.length,i=Math.ceil(Math.sqrt(selectedItems.length)),r=getCollectiveBoundingBox(selectedItems),s=r.x,n=r.y;selectedItems.forEach((e,t)=>{const r=Math.floor(t/i),l=t%i,c=s+l*(o+20),d=n+r*(a+20),h=c-e.x,p=d-e.y;e.x+=h;e.y+=p;if(e.type==='arrow'||e.type==='measure'){e.startX+=h;e.startY+=p;e.endX+=h;e.endY+=p}else if(e.type==='stroke'){e.points.forEach(e=>{e.x+=h;e.y+=p})}});saveStateForUndo()}
        function updateLeftBarState(){alignBtn.disabled=selectedItems.length<2}
        function getContrastColor(hex){if(hex.indexOf('#')===0){hex=hex.slice(1)}if(hex.length===3){hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2]}if(hex.length!==6){return'#0d0d0d'}const r=parseInt(hex.slice(0,2),16),g=parseInt(hex.slice(2,4),16),b=parseInt(hex.slice(4,6),16),yiq=((r*299)+(g*587)+(b*114))/1000;return(yiq>=128)?'#262626':'#ffffff'}
        function updateUIColors(){const e=document.documentElement.style,t=getContrastColor(canvasBackgroundColor);e.setProperty('--bg-page',canvasBackgroundColor);e.setProperty('--text-color-active-tab',t);e.setProperty('--contrast-color-light',hexToRgba(t,0.6));e.setProperty('--bg-ui','rgba(35, 38, 51, 0.4)');e.setProperty('--bg-ui-hover','rgba(55, 58, 71, 0.5)');e.setProperty('--text-color','#e2e8f0');e.setProperty('--text-color-light','#94a3b8');e.setProperty('--text-color-strong','#ffffff');e.setProperty('--border-color','rgba(255, 255, 255, 0.1)');e.setProperty('--switch-bg-checked',accentColor);canvas.style.backgroundColor=canvasBackgroundColor;bgColorPicker.value=canvasBackgroundColor;accentColorPicker.value=accentColor;toolbarAccentColorPicker.value=accentColor;gridColorPicker.value=gridColor;renderTabs()}
        function setCurrentTool(e){if(currentTool===e&&e!==null){return}currentTool=e;document.querySelectorAll('#left-bar .tool-button').forEach(e=>e.classList.remove('active'));canvas.classList.remove('eyedropper-active');if(currentTool===null){selectToolBtn.classList.add('active')}else if(currentTool==='arrow'){addArrowBtn.classList.add('active')}else if(currentTool==='text'){addTextBtn.classList.add('active')}else if(currentTool==='box'){addBoxBtn.classList.add('active')}else if(currentTool==='circle'){addCircleBtn.classList.add('active')}else if(currentTool==='measure'){addMeasureBtn.classList.add('active')}else if(currentTool==='grid'){addGridBtn.classList.add('active')}else if(currentTool==='draw'){drawBtn.classList.add('active')}else if(currentTool==='eyedropper'){eyedropperBtn.classList.add('active');canvas.classList.add('eyedropper-active')}}
        function setActiveGizmo(e){activeGizmo=activeGizmo===e?null:e;updateSelectionToolbar()}
        function togglePin(){if(selectedItems.length>0){const e=!selectedItems[0].isPinned;selectedItems.forEach(t=>t.isPinned=e);updateSelectionToolbar();saveStateForUndo()}}
        function setTextAlign(e){if(selectedItems.length===1&&selectedItems[0].type==='text'){selectedItems[0].textAlign=e;updateSelectionToolbar();saveStateForUndo()}}
        function updateGridDimension(e,t){if(selectedItems.length===1&&selectedItems[0].type==='grid'){const o=selectedItems[0],a=parseInt(t,10);if(a>0){o[e]=a;saveStateForUndo()}}}
        function updateMeasureUnit(e){if(selectedItems.length===1&&selectedItems[0].type==='measure'){selectedItems[0].unit=e.target.value;saveStateForUndo()}}
        function setTextFontFamily(e){if(selectedItems.length===1&&selectedItems[0].type==='text'){selectedItems[0].fontFamily=e.target.value;saveStateForUndo()}}
        function toggleTextStyleBold(){if(selectedItems.length===1&&selectedItems[0].type==='text'){const e=selectedItems[0];e.fontWeight=e.fontWeight==='bold'?'normal':'bold';updateSelectionToolbar();saveStateForUndo()}}
        function toggleTextStyleItalic(){if(selectedItems.length===1&&selectedItems[0].type==='text'){const e=selectedItems[0];e.fontStyle=e.fontStyle==='italic'?'normal':'italic';updateSelectionToolbar();saveStateForUndo()}}
        function updateSelectionToolbar(){const e=selectedItems.some(item=>item.type==='box'||item.type==='circle'),t=selectedItems.length>0,o=selectedItems.length>0,a=selectedItems.length>0,i=selectedItems.length>1,r=selectedItems.length===1&&selectedItems[0].type==='group',s=selectedItems.length===1&&selectedItems[0].type==='text',n=selectedItems.length===1&&selectedItems[0].type==='grid',l=selectedItems.length===1&&selectedItems[0].type==='measure',c=selectedItems.length===1&&(selectedItems[0].type==='box'||selectedItems[0].type==='circle'||selectedItems[0].type==='text'||selectedItems[0].type==='measure');if(selectedItems.length>0){selectionToolbar.style.display='flex';textToolsContainer.style.display=s?'flex':'none';gridToolsContainer.style.display=n?'flex':'none';measureToolsContainer.style.display=l?'flex':'none';itemColorToolContainer.style.display=c?'flex':'none';if(s){const e=selectedItems[0];fontFamilySelect.value=e.fontFamily||'Inter';[textAlignLeftBtn,textAlignCenterBtn,textAlignRightBtn].forEach(e=>e.classList.remove('active'));if(e.textAlign==='left')textAlignLeftBtn.classList.add('active');else if(e.textAlign==='right')textAlignRightBtn.classList.add('active');else textAlignCenterBtn.classList.add('active');textStyleBoldBtn.classList.toggle('active',e.fontWeight==='bold');textStyleItalicBtn.classList.toggle('active',e.fontStyle==='italic')}if(n){const e=selectedItems[0];gridRowsInput.value=e.rows;gridColsInput.value=e.cols}if(l){measureUnitSelect.value=selectedItems[0].unit||'px'}if(c){itemColorPicker.value=selectedItems[0].color || accentColor}toggleBoxStyleBtn.style.display=e?'flex':'none';scaleBtn.style.display=t?'flex':'none';rotateBtn.style.display=t?'flex':'none';flipHorizontalBtn.style.display=t?'flex':'none';flipVerticalBtn.style.display=t?'flex':'none';pinBtn.style.display=o?'flex':'none';bringFrontBtn.style.display=a?'flex':'none';sendBackBtn.style.display=a?'flex':'none';groupBtn.style.display=i?'flex':'none';ungroupBtn.style.display=r?'flex':'none';scaleBtn.classList.toggle('active',activeGizmo==='scale');rotateBtn.classList.toggle('active',activeGizmo==='rotate');pinBtn.classList.toggle('pinned',o&&selectedItems.every(e=>e.isPinned))}else{selectionToolbar.style.display='none';itemColorToolContainer.style.display='none';textToolsContainer.style.display='none';gridToolsContainer.style.display='none';measureToolsContainer.style.display='none';activeGizmo=null}}
        function updateToolbarPosition(){if(selectedItems.length>0){const e=getCollectiveBoundingBox(selectedItems),t=worldToScreen({x:e.x+e.width/2,y:e.y+e.height});selectionToolbar.style.left=`${t.x}px`;selectionToolbar.style.top=`${t.y}px`}}
        function editText(e){currentlyEditingText=e;e.isHidden=!0;const t=worldToScreen({x:e.x,y:e.y}),o=e.width*cameraZoom;Object.assign(textEditor.style,{display:'block',left:`${t.x}px`,top:`${t.y}px`,width:`${o}px`,height:'auto',transform:`rotate(${e.rotation}rad)`,transformOrigin:'top left',color:e.color,backgroundColor:hexToRgba(e.color,.1),fontSize:`${e.fontSize*cameraZoom}px`,fontFamily:e.fontFamily||'Inter',textAlign:e.textAlign||'center',fontWeight:e.fontWeight||'bold',fontStyle:e.fontStyle||'normal'});textEditor.value=e.text==="Type..."?"":e.text;textEditor.focus();autoResizeTextEditor();selectedItems=[];updateToolbarPosition();updateLeftBarState()}
        function finishEditingText(){if(currentlyEditingText){currentlyEditingText.text=textEditor.value.trim()||"Type...";const e=currentlyEditingText,t=e.fontStyle||'normal',o=e.fontWeight||'bold',a=e.fontFamily||'Inter';ctx.font=`${t} ${o} ${e.fontSize}px '${a}', sans-serif`;const i=textEditor.value.split('\n');let r=0;i.forEach(e=>{const t=ctx.measureText(e);if(t.width>r)r=t.width});currentlyEditingText.width=r+20;currentlyEditingText.height=textEditor.scrollHeight/cameraZoom;currentlyEditingText.isHidden=!1;selectedItems=[currentlyEditingText];saveStateForUndo();currentlyEditingText=null}textEditor.style.display='none'}
        function autoResizeTextEditor(){textEditor.style.height='auto';textEditor.style.height=textEditor.scrollHeight+'px'}
        function saveStateForUndo(){const e=JSON.stringify(items,(e,t)=>{if(e==='img'){return t.src}return t});if(historyIndex<historyStack.length-1){historyStack=historyStack.slice(0,historyIndex+1)}if(historyStack.length>0&&historyStack[historyStack.length-1]===e)return;historyStack.push(e);historyIndex++;if(historyStack.length>HISTORY_LIMIT){historyStack.shift();historyIndex--}}
        function loadStateFromHistory(e){const t=JSON.parse(e);selectedItems=[];updateSelectionToolbar();updateLeftBarState();const o=e=>{return e.map(e=>{const t={...(e.scaleX!==void 0?{}:{scaleX:1,scaleY:1}),...e};if(t.type==='image'){const itemState=t; const img=new Image;img.src=itemState.img;t.img=img}else if(t.type==='group'){t.items=o(t.items)}return t})};items=o(t)} // Fixed: used itemState instead of t inside image loading
        function undoLastAction(){if(historyIndex>0){historyIndex--;const e=historyStack[historyIndex];loadStateFromHistory(e)}}
        function redoLastAction(){if(historyIndex<historyStack.length-1){historyIndex++;const e=historyStack[historyIndex];loadStateFromHistory(e)}}
        function groupSelectedItems(){if(selectedItems.length<=1)return;saveStateForUndo();const e=[];selectedItems.forEach(t=>{if(t.type==='group'){const o=t.x+t.width/2,a=t.y+t.height/2,i=Math.cos(t.rotation),r=Math.sin(t.rotation);t.items.forEach(s=>{const n=JSON.parse(JSON.stringify(s));reattachImages(s,n);const l=s.x+s.width/2,c=s.y+s.height/2,d=l-t.width/2,h=c-t.height/2,p=d*i-h*r,m=d*r+h*i,u=o+p,g=a+m;n.x=u-s.width/2;n.y=g-s.height/2;n.rotation=(s.rotation||0)+t.rotation;if(n.type==='arrow'||n.type==='stroke'||n.type==='measure'){const e=(e,l)=>{const c=t.x+e.x,d=t.y+e.y,h=c-o,p=d-a,m=h*i-p*r,u=h*r+p*i;return{x:o+m,y:a+u}};if(n.type==='arrow'||n.type==='measure'){const t=e({x:s.startX-s.x,y:s.startY-s.y}),o=e({x:s.endX-s.x,y:s.endY-s.y});n.startX=t.x;n.startY=t.y;n.endX=o.x;n.endY=o.y}else{n.points=s.points.map(t=>e({x:t.x-s.x,y:t.y-s.y}))}}e.push(n)})}else{e.push(t)}});const t=getCollectiveBoundingBox(e),o={id:Date.now(),type:'group',x:t.x,y:t.y,width:t.width,height:t.height,rotation:0,isPinned:!1,opacity:1,scaleX:1,scaleY:1,items:[]};e.forEach(e=>{const t=JSON.parse(JSON.stringify(e));reattachImages(e,t);t.x-=o.x;t.y-=o.y;if(t.type==='arrow'||t.type==='measure'){t.startX-=o.x;t.startY-=o.y;t.endX-=o.x;t.endY-=o.y}else if(t.type==='stroke'){t.points.forEach(e=>{e.x-=o.x;e.y-=o.y})}o.items.push(t)});const a=new Set(selectedItems.map(e=>e.id));items=items.filter(e=>!a.has(e.id));items.push(o);selectedItems=[o];updateSelectionToolbar();updateLeftBarState()}
        function ungroupSelectedItems(){const e=selectedItems.filter(e=>e.type==='group');if(e.length===0)return;saveStateForUndo();const t=[],o=new Set;e.forEach(e=>{o.add(e.id);const a=e.x+e.width/2,i=e.y+e.height/2,r=Math.cos(e.rotation),s=Math.sin(e.rotation);e.items.forEach(o=>{const n=JSON.parse(JSON.stringify(o));reattachImages(o,n);if(n.type==='arrow'||n.type==='stroke'||n.type==='measure'){const t=(t,l)=>{const c=e.x+t.x,d=e.y+t.y,h=c-a,p=d-i,m=h*r-p*s,u=h*s+p*r;return{x:a+m,y:i+u}};if(n.type==='arrow'||n.type==='measure'){const e=t({x:o.startX-o.x,y:o.startY-o.y}),a=t({x:o.endX-o.x,y:o.endY-o.y});n.startX=e.x;n.startY=e.y;n.endX=a.x;n.endY=a.y}else{n.points=o.points.map(e=>t({x:e.x-o.x,y:e.y-o.y}))}}const l=o.x+o.width/2,c=o.y+o.height/2,d=l-e.width/2,h=c-e.height/2,p=d*r-h*s,m=d*s+h*r,u=a+p,g=i+m;n.x=u-o.width/2;n.y=g-o.height/2;n.rotation=(o.rotation||0)+e.rotation;items.push(n);t.push(n)})});items=items.filter(e=>!o.has(e.id));selectedItems=t;updateSelectionToolbar();updateLeftBarState()}
        function buildPaletteMenu(){palettePanel.innerHTML='';colorPalettes.forEach(palette=>{const option=document.createElement('div');option.className='palette-option';option.innerHTML=`<div class="palette-color" style="background-color: ${palette.bg}"></div><div class="palette-color" style="background-color: ${palette.accent}"></div><div class="palette-color" style="background-color: ${palette.grid}"></div>`;option.addEventListener('click',()=>{const activeProject=projects.find(p=>p.id===activeProjectId);if(activeProject&&(activeProject.type==='moodinfinite'||activeProject.type==='moodprompt')){activeProject.data.canvasBackgroundColor=palette.bg;canvasBackgroundColor=palette.bg;if(activeProject.type==='moodinfinite'){activeProject.data.accentColor=palette.accent;activeProject.data.gridColor=palette.grid;accentColor=palette.accent;gridColor=palette.grid}updateUIColors()}palettePanel.classList.remove('open')});palettePanel.appendChild(option)})}
        function showToast(e,t='success'){if(!showNotifications)return;const o=document.getElementById('toast-container');if(!o)return;const a=document.createElement('div');a.className=`toast-notification ${t}`;let i='';if(t==='success'){i=`<svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`}else if(t==='error'){i=`<svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`}a.innerHTML=`${i}<span>${e}</span>`;o.appendChild(a);setTimeout(()=>{a.remove()},3e3)}
        
        let lastTap = 0, longPressTimer = null, isPinching = false, initialPinchDistance = null, lastPinchCenter = null, initialCameraZoomOnPinch = 1;
        function onTouchStart(e) {
            e.preventDefault(); clearTimeout(longPressTimer);
            if (e.touches.length === 1 && !isPinching) {
                const currentTime = new Date().getTime(); const tapLength = currentTime - lastTap;
                if (tapLength < 300 && tapLength > 0) { onDoubleClick(normalizeTouchEvent(e)); lastTap = 0; return; }
                lastTap = currentTime;
                longPressTimer = setTimeout(() => { const contextEvent = { preventDefault: () => {}, ...normalizeTouchEvent(e) }; onContextMenu(contextEvent); if (navigator.vibrate) { navigator.vibrate(50); } }, 750); 
                onMouseDown(normalizeTouchEvent(e));
            } else if (e.touches.length === 2) {
                isDrawing = false; isMovingItems = false; isTransforming = false; isTransformingArrow = false; isSelectingBox = false; isPinching = true;
                initialPinchDistance = getPinchDistance(e); lastPinchCenter = getPinchCenter(e); initialCameraZoomOnPinch = cameraZoom;
            }
        }
        function onTouchMove(e) {
            e.preventDefault(); clearTimeout(longPressTimer); 
            if (e.touches.length === 1 && !isPinching) { onMouseMove(normalizeTouchEvent(e));
            } else if (e.touches.length === 2 && isPinching) {
                const center = getPinchCenter(e);
                const deltaX = center.x - lastPinchCenter.x; const deltaY = center.y - lastPinchCenter.y;
                cameraOffset.x += deltaX / cameraZoom; cameraOffset.y += deltaY / cameraZoom;
                const dist = getPinchDistance(e); const zoomFactor = dist / initialPinchDistance; const newZoom = initialCameraZoomOnPinch * zoomFactor;
                const worldPosBeforeZoom = screenToWorld(center); cameraZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, newZoom)); const worldPosAfterZoom = screenToWorld(center);
                cameraOffset.x += worldPosAfterZoom.x - worldPosBeforeZoom.x; cameraOffset.y += worldPosAfterZoom.y - worldPosBeforeZoom.y;
                lastPinchCenter = center;
            }
        }
        function onTouchEnd(e) {
            e.preventDefault(); clearTimeout(longPressTimer); 
            if (e.touches.length < 2) { isPinching = false; initialPinchDistance = null; lastPinchCenter = null; }
            if (e.touches.length === 0) { onMouseUp(normalizeTouchEvent(e)); }
        }
        
        function getPinchDistance(e){const t=e.touches[0],o=e.touches[1];return Math.hypot(t.clientX-o.clientX,t.clientY-o.clientY)}
        function getPinchCenter(e){const t=e.touches[0],o=e.touches[1];return{x:(t.clientX+o.clientX)/2,y:(t.clientY+o.clientY)/2}}
        function normalizeTouchEvent(e){let t;if(e.touches&&e.touches.length>0){t=e.touches[0]}else if(e.changedTouches&&e.changedTouches.length>0){t=e.changedTouches[0]}else{return{clientX:0,clientY:0,button:0,target:e.target}}return{clientX:t.clientX,clientY:t.clientY,button:0,target:e.target}}
        function getEventLocation(e){const rect=canvas.getBoundingClientRect();return{x:e.clientX-rect.left,y:e.clientY-rect.top}}
        function screenToWorld(e){return{x:(e.x-canvas.width/2)/cameraZoom-cameraOffset.x+canvas.width/2,y:(e.y-canvas.height/2)/cameraZoom-cameraOffset.y+canvas.height/2}}
        function worldToScreen(e){return{x:(e.x+cameraOffset.x-canvas.width/2)*cameraZoom+canvas.width/2,y:(e.y+cameraOffset.y-canvas.height/2)*cameraZoom+canvas.height/2}}
        function reattachImages(e,t){if(!e||!t)return;if(e.type==='image'&&e.img instanceof HTMLImageElement){t.img=e.img}else if(e.type==='group'){if(e.items&&t.items){e.items.forEach((e,o)=>{reattachImages(e,t.items[o])})}}}
        function getItemAtPosition(e){for(let t=items.length-1;t>=0;t--){const o=items[t],a=getItemBoundingBox(o);if(e.x>=a.x&&e.x<=a.x+a.width&&e.y>=a.y&&e.y<=a.y+a.height){if(o.type==='group'){const t=o.x+o.width/2,a=o.y+o.height/2,i=e.x-t,r=e.y-a,s=Math.cos(-o.rotation),n=Math.sin(-o.rotation),l=i*s-r*n,c=i*n+r*s,d=l+t-o.x,h=c+a-o.y;for(let e=o.items.length-1;e>=0;e--){const t=o.items[e],a={x:t.x,y:t.y,width:t.width,height:t.height};if(d>=a.x&&d<=a.x+a.width&&h>=a.y&&h<=a.y+a.height){return o}}}if(o.type==='stroke'||o.type==='arrow'||o.type==='measure'){const a=getItemBoundingBox(o);if(e.x>=a.x-10/cameraZoom&&e.x<=a.x+a.width+10/cameraZoom&&e.y>=a.y-10/cameraZoom&&e.y<=a.y+a.height+10/cameraZoom){if(o.type==='stroke'){for(let t=0;t<o.points.length-1;t++){if(Math.sqrt(distToSegmentSquared(e,o.points[t],o.points[t+1]))<10/cameraZoom)return o}}else if(o.type==='arrow'||o.type==='measure'){if(Math.sqrt(distToSegmentSquared(e,{x:o.startX,y:o.startY},{x:o.endX,y:o.endY}))<10/cameraZoom)return o}}}else{const t=o.x+o.width/2,a=o.y+o.height/2,i=e.x-t,r=e.y-a,s=-o.rotation,n=i*Math.cos(s)-r*Math.sin(s),l=i*Math.sin(s)+r*Math.cos(s);if(n>-o.width/2&&n<o.width/2&&l>-o.height/2&&l<o.height/2)return o}}}return null}
        function getGizmoAtPosition(e){if(selectedItems.length!==1||!activeGizmo)return null;const t=selectedItems[0];if(t.isPinned||t.type==='arrow'||t.type==='stroke'||t.type==='measure')return null;const o=14/cameraZoom,a=t.x+t.width/2,i=t.y+t.height/2;if(activeGizmo==='rotate'){const r=t.width/2,s=-t.height/2-20/cameraZoom,n=r*Math.cos(t.rotation)-s*Math.sin(t.rotation),l=r*Math.sin(t.rotation)+s*Math.cos(t.rotation);if(Math.hypot(e.x-(a+n),e.y-(i+l))<o)return'rotate'}else if(activeGizmo==='scale'){const r=t.width/2,s=t.height/2,n=r*Math.cos(t.rotation)-s*Math.sin(t.rotation),l=r*Math.sin(t.rotation)+s*Math.cos(t.rotation);if(Math.hypot(e.x-(a+n),e.y-(i+l))<o)return'scale'}return null}
        function getArrowHandleAtPosition(e){if(selectedItems.length!==1)return null;const t=selectedItems[0];if(t.isPinned||(t.type!=='arrow'&&t.type!=='measure'))return null;const o=12/cameraZoom;if(Math.hypot(e.x-t.startX,e.y-t.startY)<o)return'start';if(Math.hypot(e.x-t.endX,e.y-t.endY)<o)return'end';return null}
        function getCollectiveBoundingBox(e){if(e.length===0)return{x:0,y:0,width:0,height:0};let t=Infinity,o=Infinity,a=-Infinity,i=-Infinity;e.forEach(e=>{const r=getItemBoundingBox(e);t=Math.min(t,r.x);o=Math.min(o,r.y);a=Math.max(a,r.x+r.width);i=Math.max(i,r.y+r.height)});return{x:t,y:o,width:a-t,height:i-o}}
        function getItemBoundingBox(e){if(e.type==='group'){if(!e.items||e.items.length===0){return{x:e.x,y:e.y,width:e.width,height:e.height}}let t=Infinity,o=Infinity,a=-Infinity,i=-Infinity;const r=e.x+e.width/2,s=e.y+e.height/2,n=Math.cos(e.rotation),l=Math.sin(e.rotation);e.items.forEach(c=>{const d=getItemBoundingBox(c),h=[{x:d.x,y:d.y},{x:d.x+d.width,y:d.y},{x:d.x+d.width,y:d.y+d.height},{x:d.x,y:d.y+d.height}];h.forEach(c=>{const d=(e.x+c.x)-r,h=(e.y+c.y)-s,p=d*n-h*l,m=d*l+h*n,u=r+p,g=s+m;t=Math.min(t,u);o=Math.min(o,g);a=Math.max(a,u);i=Math.max(i,g)})});return{x:t,y:o,width:a-t,height:i-o}}if(e.type==='stroke'){let t=Infinity,o=Infinity,a=-Infinity,i=-Infinity;if(e.points&&e.points.length>0){e.points.forEach(e=>{t=Math.min(t,e.x);o=Math.min(o,e.y);a=Math.max(a,e.x);i=Math.max(i,e.y)});return{x:t,y:o,width:a-t,height:i-o}}return{x:e.x,y:e.y,width:0,height:0}}if(e.type==='arrow'||e.type==='measure'){return{x:Math.min(e.startX,e.endX),y:Math.min(e.startY,e.endY),width:Math.abs(e.startX-e.endX),height:Math.abs(e.startY-e.endY)}}const t=e.width,o=e.height,a=e.x+t/2,i=e.y+o/2,r=e.rotation,s=Math.cos(r),n=Math.sin(r);let l=Infinity,c=Infinity,d=-Infinity,h=-Infinity;[{x:-t/2,y:-o/2},{x:t/2,y:-o/2},{x:t/2,y:o/2},{x:-t/2,y:o/2}].forEach(e=>{const t=e.x*s-e.y*n+a,o=e.x*n+e.y*s+i;l=Math.min(l,t);c=Math.min(c,o);d=Math.max(d,t);h=Math.max(h,o)});return{x:l,y:c,width:d-l,height:h-c}}
        function rectsIntersect(e,t){return!(t.x>e.x+e.width||t.x+t.width<e.x||t.y>e.y+e.height||t.y+t.height<e.y)}
        function getNormalizedSelectionBox(){return{x:Math.min(selectionBox.startX,selectionBox.endX),y:Math.min(selectionBox.startY,selectionBox.endY),width:Math.abs(selectionBox.startX-selectionBox.endX),height:Math.abs(selectionBox.startY-selectionBox.endY)}}
        function hexToRgba(e,t){let o=0,a=0,i=0;if(e.length==4){o="0x"+e[1]+e[1];a="0x"+e[2]+e[2];i="0x"+e[3]+e[3]}else if(e.length==7){o="0x"+e[1]+e[2];a="0x"+e[3]+e[4];i="0x"+e[5]+e[6]}return`rgba(${+o},${+a},${+i},${t})`}
        function rgbToHex(e,t,o){return"#"+((1<<24)+(e<<16)+(t<<8)+o).toString(16).slice(1)}
        function distSq(e,t){return Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)}
        function distToSegmentSquared(e,t,o){const a=distSq(t,o);if(a===0)return distSq(e,t);let i=((e.x-t.x)*(o.x-t.x)+(e.y-t.y)*(o.y-t.y))/a;i=Math.max(0,Math.min(1,i));return distSq(e,{x:t.x+i*(o.x-t.x),y:t.y+i*(o.y-t.y)})}
        function invertColor(e){if(e.indexOf('#')===0)e=e.slice(1);if(e.length===3)e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2];if(e.length!==6)return'#ffffff';const t=(255-parseInt(e.slice(0,2),16)).toString(16),o=(255-parseInt(e.slice(2,4),16)).toString(16),a=(255-parseInt(e.slice(4,6),16)).toString(16);return'#'+padZero(t)+padZero(o)+padZero(a)}
        function padZero(e,t){t=t||2;const o=(new Array(t+1)).join('0');return(o+e).slice(-t)}
        function adjustZoom(e,t){if(isDragging)return;const o=screenToWorld(getEventLocation(e));cameraZoom=Math.max(MIN_ZOOM,Math.min(MAX_ZOOM,cameraZoom*(1+t)));const a=screenToWorld(getEventLocation(e));cameraOffset.x+=a.x-o.x;cameraOffset.y+=a.y-o.y}

        loadSettings();
        setupEventListeners();
        buildPaletteMenu();
        createNewProject('moodinfinite');
        gameLoop();
    </script>
</body>
</html>